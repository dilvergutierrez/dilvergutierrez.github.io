<html>
  <body>
    USE [CentroCobranzas]
GO
/****** Object:  StoredProcedure [dbo].[PD_SEGUIMORA]    Script Date: 27/04/2023 15:55:34 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[PD_SEGUIMORA]

AS

-----------------------------------------------------------------------------
---BASE DECRECIENTE JUDICIAL
------------------------------------------------------------------------------
--SELECT *
--INTO #TMP_DIARIO_FIN
--FROM PD_UNIVERSO_DIARIO_HISTORICO
--WHERE FECHA='20200331'

--SELECT *
--INTO #TMP_DECRECE_FIN
--FROM PD_DECRECIENTE_HISTORICO
--WHERE FECHA='20200331'

--DECLARE @FECHA1 DATETIME

--SET @FECHA1=(SELECT MAX(FECHA) FROM PD_UNIVERSO_DIARIO)

declare @FECHA1 DATETIME, @FECHA2 DATETIME,@FECHA3 DATETIME, @FECHA4 DATETIME,@FECHA5 DATETIME, @FECHA6 DATETIME,@FECHA7 DATETIME, @FECHA8 DATETIME, @FECHA9 DATETIME, @FECHA10 DATETIME

SET @FECHA1=(select max(FECHA) from PD_UNIVERSO_DIARIO)
SET @FECHA2= (select max(FECHADATOS) from XCOM_ASIGNACION_ESTUDIOS_HOY)
--SET @FECHA2=(select max(FECHADATOS) from XCOM_AE_Observaciones_HOY)
--SET @FECHA3=(select max(FECHADATOS) from XCOM_SAEDTASI_HOY)
--SET @FECHA4=(select max(FECHADATOS) from XCOM_SAEAEDTPCT)
--SET @FECHA5=(select max(FECHADATOS) from XCOM_SAEDTFSS)
SET @FECHA3=(select max(FECHA_INGRESO) from XCOM_MAE_INGRESOS)
SET @FECHA4=(select max(FECHA_SALIDAS) from XCOM_MAE_SALIDAS)
SET @FECHA5=(select max(FECHADATOS) from PD_DECRECIENTE_DIARIO)
SET @FECHA6=(select max(FECHA) from PD_DECRECIENTE_JUDICIAL_GESTION)   --aqui
SET @FECHA7=(select max(fechadatos) from XCOMLogCargas where archivo like 'CONDEFEX%' AND LEN(archivo) = 21 AND estado= 1 AND estadodiario= 1)

IF (@FECHA1 = @FECHA2) and (@FECHA1=@FECHA3) and (@FECHA1=@FECHA4) and (@FECHA1 = @FECHA5) and (@FECHA1=@FECHA7) AND (@FECHA1<>@FECHA6)

BEGIN

update JOB_Ejecucion
SET tarea_en_ejecucion='INICIO PD_SEGUIMORA'
,fecha_inicio_tarea=GETDATE()
WHERE Descripcion='PROCESO_DIARIO'

/*AJUSTA VALORES ERRONEOS EN LA DATA*/
If OBJECT_ID('tempdb..#TMP_SAEDTFSS') IS NOT NULL DROP TABLE #TMP_SAEDTFSS
SELECT *
INTO #TMP_SAEDTFSS
FROM XCOM_SAEDTFSS
WHERE FECHADATOS=(SELECT MAX(FECHADATOS) FROM XCOM_SAEDTFSS)

UPDATE #TMP_SAEDTFSS
SET FECFASE=CASE WHEN YEAR(FECFASE) BETWEEN 2100 AND 2109 THEN DATEADD(YEAR,-90,FECFASE)
WHEN YEAR(FECFASE) =2099 THEN DATEADD(YEAR,-90,FECFASE)
WHEN YEAR(FECFASE) BETWEEN 2110 AND 2119 THEN DATEADD(YEAR,-100,FECFASE)
WHEN YEAR(FECFASE) BETWEEN 2200 AND 2209 THEN DATEADD(YEAR,-200,FECFASE)
ELSE FECFASE END

-----------------------------------------------------------------------------------------

EXEC SP_CREA_TMP_SEGUIMORA ---añdir sigla,SUBPROD,Flag Consumer,Flag Fondo FAE,Flag Fondo Crecer,Flag Fondo Reactiva,Flag Convenio

-----------------------------------------------------------------------------------------------------------------------------------------
----SALDO JUDICIAL

If OBJECT_ID('tempdb..#TCCOB_SJ') IS NOT NULL DROP TABLE #TCCOB_SJ
select *
into #TCCOB_SJ
from XCOM_TCCOB
where FECHADATOS=@FECHA1
and ((TIP_CAMB='S' and DIVISA<>'VAC') or (TIP_CAMB='V' and DIVISA='VAC'))

If OBJECT_ID('tempdb..#ContratoBC_TotalSolarizado') IS NOT NULL DROP TABLE #ContratoBC_TotalSolarizado
SELECT substring(A.contrato,1,8)+substring(A.contrato,11,10) cont_sae,a.*,CASE WHEN A.MONEDA='USD' THEN C.TC_COMPR*A.SALDO ELSE A.SALDO END SALDO_SOL
into #ContratoBC_TotalSolarizado
FROM pd_decreciente_diario a
LEFT JOIN #TCCOB_SJ C
ON A.FECHADATOS=C.FEC_CAMB AND C.TIP_CAMB='S' AND C.DIVISA='USD'
where a.clave IN ('BC') AND a.SALDO>0

UPDATE A
SET A.SALDO_SOL=A.SALDO_SOL*B.TC_COMPR
FROM (SELECT * FROM #ContratoBC_TotalSolarizado WHERE MONEDA='VAC') AS A
INNER JOIN #TCCOB_SJ AS B
ON  A.FECHADATOS=B.FEC_CAMB AND B.TIP_CAMB='V'

If OBJECT_ID('tempdb..#ContratoBC_TotalSolarizado_Total') IS NOT NULL DROP TABLE #ContratoBC_TotalSolarizado_Total
select CONT_SAE CONTRATO,SUM(SALDO_SOL) SALDO_SOL
into #ContratoBC_TotalSolarizado_Total
from #ContratoBC_TotalSolarizado
GROUP BY CONT_SAE
-----------------------------------------------------------------------------------------------------------------------------------------

INSERT INTO PD_DECRECIENTE_JUDICIAL
SELECT Fecha,Codcentral,CONTRATO,CLIENTE,PRODUCTO,VIG,REF,VEN,NULL,OFICINA,TERRITORIO,
NULL,SEGMENTO_RIESGO,CODOFIC,
NULL,NULL,NULL,NULL,NULL,NULL,DEUDATOTAL,provconst,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,
NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,
NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,
NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,
NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,
NULL,NULL,NULL,CLASIFICACION,NULL,NULL,NULL,DA,NULL,NULL,DNI,RUC,ENTIDAD_TIPO,NULL,NULL,NULL,NULL,NULL,NULL,NULL
,NULL,NULL,NULL,TIPCRE, NULL,NULL, NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
FROM PD_UNIVERSO_DIARIO
ORDER BY CODCENTRAL ASC


--------------AÑADIDO 29/12/2021
UPDATE A
SET A.[SALDO JUDICIAL]=b.SALDO_SOL
FROM PD_DECRECIENTE_JUDICIAL AS A
LEFT JOIN #ContratoBC_TotalSolarizado_Total AS B ON A.CONTRATO=B.CONTRATO
-------------------------------------------------------


update PD_DECRECIENTE_JUDICIAL
set TERRITORIO='BEC CENTRAL'
where CODOFIC='0949'


If OBJECT_ID('tempdb..#tmp_estudio') IS NOT NULL DROP TABLE #tmp_estudio
SELECT a.contrato,b.nomb_estu,a.coddato sigla
into #tmp_estudio
FROM XCOM_ASIGNACION_ESTUDIOS_HOY  a
left join pd_catalogo_estudios b
on a.coddato=b.sigla

--delete from #tmp_estudio where contrato in (select contrato from XCOM_ASIGNACION_ESTUDIOS_HOY
--where CODDATO in (select sigla from PD_CATALOGO_ESTUDIOS where retiro=0))

--insert into #tmp_estudio
--select a.contrato,b.nomb_estu,a.coddato sigla
--from XCOM_ASIGNACION_ESTUDIOS_HOY A
--left join pd_catalogo_estudios b
--on a.coddato=b.sigla
--where A.CODDATO in (select sigla from PD_CATALOGO_ESTUDIOS where retiro=0)
--and a.contrato not in (select contrato from #tmp_estudio)

UPDATE A
SET A.[ESTUDIO ASIGNADO]=b.nomb_estu,
A.sigla=b.sigla
FROM PD_DECRECIENTE_JUDICIAL AS A
LEFT JOIN #tmp_estudio AS B ON A.CONTRATO=B.CONTRATO

---------------------------------
---> FECHA DE INGRESO A MORA
---------------------------------

UPDATE A
SET A.FECHA_INGRESO_MORA=B.FECHA_INGRESO
FROM PD_DECRECIENTE_JUDICIAL AS A
INNER JOIN (SELECT FECHA_INGRESO,CONT_SAE,SUM(SOLES)SOLES,SUM(DOLARES)DOLARES
FROM XCOM_MAE_INGRESOS WHERE ENTIDAD IN ('BC','EXJ') GROUP BY FECHA_INGRESO,CONT_SAE) AS B
ON A.CONTRATO=B.CONT_SAE AND (B.SOLES >0 OR B.DOLARES>0)
WHERE A.FECHA_INGRESO_MORA IS NULL


---------------------
---> TRAMO_MORA
---------------------

UPDATE A
SET A.TRAMO_MORA=case
when cast(getdate()-fecha_ingreso_mora as int)-1 <= 60 then 'Menor a 2 Meses'
when cast(getdate()-fecha_ingreso_mora as int)-1 between 60 and 90 then '2-3 Meses'
when cast(getdate()-fecha_ingreso_mora as int)-1 between 90 and 180 then '3-6 Meses'
when cast(getdate()-fecha_ingreso_mora as int)-1 >=  180 then 'Mayor 6 Meses'
else 'sindatos' end
FROM PD_DECRECIENTE_JUDICIAL AS A

---------------------------------
---> TIEMPO DE PROCESO JUDICIAL
---------------------------------
UPDATE A
SET A.TIEMPO_EN_JUDICIAL=case
when cast(getdate()-fecha_ingreso_mora as int)-1 < 60 then '< 2meses'
when cast(getdate()-fecha_ingreso_mora as int)-1 between 60 and 180 then '2 meses - 6meses'
when cast(getdate()-fecha_ingreso_mora as int)-1 between 180 and 365 then '6 meses - 1año'
when cast(getdate()-fecha_ingreso_mora as int)-1 between 360 and 730 then '1año-2años'
when cast(getdate()-fecha_ingreso_mora as int)-1 >=  730 then '> 2años'
else 'sindatos' end
FROM PD_DECRECIENTE_JUDICIAL AS A


---> PRODUCTO_FINAL--CAMBIO JUAN PERALTA
UPDATE A
SET A.PRODUCTO_FINAL=CASE    WHEN PRODUCTO IN ('PRÉSTAMOS CONSUMO') AND [SEGMENTO DE NEGOCIO]='PARTICULARES' THEN 'P.Consumo'
WHEN PRODUCTO IN ('PRÉSTAMOS COMERCIALES','PRÉSTAMOS PYMES') AND [SEGMENTO DE NEGOCIO]='PARTICULARES' THEN 'P.Consumo'
WHEN PRODUCTO IN ('TARJETA CONSUMO') AND [SEGMENTO DE NEGOCIO]='PARTICULARES' THEN 'T.Consumo'
WHEN PRODUCTO IN ('TARJETA COMERCIALES','TARJETAS PYMES') AND [SEGMENTO DE NEGOCIO]='PARTICULARES' THEN 'T.Consumo'
WHEN PRODUCTO IN ('PRÉSTAMO VEHICULAR') AND [SEGMENTO DE NEGOCIO]='PARTICULARES' THEN 'P.Vehicular'
WHEN PRODUCTO IN ('HIPOTECARIO') AND [SEGMENTO DE NEGOCIO]='PARTICULARES' THEN 'Hipotecario'
WHEN PRODUCTO is null  and substring(contrato, 9,2)='96' AND [SEGMENTO DE NEGOCIO]='PARTICULARES' then 'P.Consumo'
WHEN PRODUCTO is null  and substring(contrato, 9,2)='50' AND [SEGMENTO DE NEGOCIO]='PARTICULARES' then 'T.Consumo'

WHEN PRODUCTO IN ('PRÉSTAMOS CONSUMO') AND [SEGMENTO DE NEGOCIO]='PYME' THEN 'P.Comercial'
WHEN PRODUCTO IN ('PRÉSTAMOS COMERCIALES','PRÉSTAMOS PYMES') AND [SEGMENTO DE NEGOCIO]='PYME' THEN 'P.Comercial'
WHEN PRODUCTO IN ('TARJETA CONSUMO') AND [SEGMENTO DE NEGOCIO]='PYME' THEN 'T.Comercial'
WHEN PRODUCTO IN ('TARJETA COMERCIALES','TARJETAS PYMES') AND [SEGMENTO DE NEGOCIO]='PYME' THEN 'T.Comercial'
WHEN PRODUCTO IN ('LEASING') AND [SEGMENTO DE NEGOCIO]='PYME' THEN 'Leasing'
WHEN PRODUCTO IN ('CRED. INMOBILIARIOS') AND [SEGMENTO DE NEGOCIO]='PYME' THEN 'C.Inmobiliarios'
WHEN PRODUCTO is null  and substring(contrato, 9,2)='96' AND [SEGMENTO DE NEGOCIO]='PYME' then 'P.Comercial'
WHEN PRODUCTO is null  and substring(contrato, 9,2)='50' AND [SEGMENTO DE NEGOCIO]='PYME' then 'T.Comercial'

WHEN PRODUCTO IN ('PRÉSTAMOS CONSUMO') AND [SEGMENTO DE NEGOCIO] NOT IN ('PYME','PARTICULARES') THEN 'P.Comercial'
WHEN PRODUCTO IN ('PRÉSTAMOS COMERCIALES','PRÉSTAMOS PYMES') AND [SEGMENTO DE NEGOCIO]  NOT IN ('PYME','PARTICULARES') THEN 'P.Comercial'
WHEN PRODUCTO IN ('TARJETA CONSUMO') AND [SEGMENTO DE NEGOCIO] NOT IN ('PYME','PARTICULARES') THEN 'T.Comercial'
WHEN PRODUCTO IN ('TARJETA COMERCIALES','TARJETAS PYMES') AND [SEGMENTO DE NEGOCIO] NOT IN ('PYME','PARTICULARES') THEN 'T.Comercial'
WHEN PRODUCTO IN ('LEASING') AND [SEGMENTO DE NEGOCIO] NOT IN ('PYME','PARTICULARES') THEN 'Leasing'
WHEN PRODUCTO IN ('CRED. INMOBILIARIOS') AND [SEGMENTO DE NEGOCIO] NOT IN ('PYME','PARTICULARES') THEN 'C.Inmobiliarios'
WHEN PRODUCTO is null  and substring(contrato, 9,2)='96' AND [SEGMENTO DE NEGOCIO] NOT IN ('PYME','PARTICULARES') then 'P.Comercial'
WHEN PRODUCTO is null  and substring(contrato, 9,2)='50' AND [SEGMENTO DE NEGOCIO] NOT IN ('PYME','PARTICULARES') then 'T.Comercial'

else 'Otros' end
FROM PD_DECRECIENTE_JUDICIAL as a


--CAMBIO JPERALTA
-------------------
---> FLAG_GIA_REAL
---------------------
update a
set a.FLAG_GIA_REAL=case when b.codcentral is null then 'NO' else 'SI' end
from PD_DECRECIENTE_JUDICIAL A left join GARANTIAS_MES B
on  a.codcentral=b.codcentral and b.HIPOTECA>0

---------------------
---> FLAG_GIA_FIADOR
---------------------
If OBJECT_ID('tempdb..#MHV_CRGA14') IS NOT NULL DROP TABLE #MHV_CRGA14
SELECT *
INTO #MHV_CRGA14
FROM XCOM_CRDT014_Fianza_Solidaria
WHERE FECHADATOS=(SELECT MAX(FECHADATOS) FROM XCOM_CRDT014_Fianza_Solidaria)

UPDATE A
SET A.FLAG_GIA_FIADOR='SI'
FROM PD_DECRECIENTE_JUDICIAL AS A ,
(SELECT DISTINCT A.CODCENTRAL,C.C_CENT_CLIE
FROM GARANTIAS_MES  AS A,
(SELECT A.C_CENT_CLIE, A.N_GARANTIA, B.FIADOR
FROM GARANTIAS_DETALLE AS A LEFT JOIN #MHV_CRGA14  AS B
ON A.N_GARANTIA=B.GARANTIA
WHERE I_TIPO_GARA='311'
)  C
WHERE A.CODCENTRAL=C.FIADOR and (a.hipoteca>0 OR A.PRENDA>0)) D
WHERE A.Codcentral=D.C_CENT_CLIE


---> FIADOR
UPDATE A
SET A.FLAG_GIA_FIADOR='NO'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.FLAG_GIA_FIADOR IS NULL

---------------------
---> ESTUDIO   WR51
---------------------
UPDATE C
SET C.[ESTUDIO ASIGNADO WR51]=D.nomb_estu
FROM PD_DECRECIENTE_JUDICIAL AS C,
(SELECT A.CONTRATO, A.ESTUDIO, B.nomb_estu
FROM PD_DECRECIENTE_DIARIO  AS A , PD_CATALOGO_ESTUDIOS AS B
WHERE A.ESTUDIO=B.SIGLA
AND A.ESTUDIO<>''  ) D
WHERE C.CONTRATO=SUBSTRING(D.CONTRATO,1,8)+SUBSTRING(D.CONTRATO,11,10)

---------------------
---> FLAG_FIANZA
---------------------
UPDATE A
SET A.FLAG_FIANZA=CASE WHEN B.CODCENTRAL IS NULL THEN 'NO' ELSE 'SI' END
FROM PD_DECRECIENTE_JUDICIAL AS A
LEFT JOIN GARANTIAS_MES AS B ON A.CODCENTRAL=B.CODCENTRAL AND B.FIANZA>0

---------------------
---> LIQUIDAS
---------------------

UPDATE A
SET A.LIQUIDAS=CASE WHEN B.CODCENTRAL IS NULL THEN 'NO' ELSE 'SI' END
FROM PD_DECRECIENTE_JUDICIAL AS A
LEFT JOIN GARANTIAS_MES AS B ON A.CODCENTRAL=B.CODCENTRAL AND B.LIQUIDAS>0

---------------------
---> PRENDA
---------------------
UPDATE A
SET A.PRENDA=CASE WHEN B.CODCENTRAL IS NULL THEN 'NO' ELSE 'SI' END
FROM PD_DECRECIENTE_JUDICIAL AS A
LEFT JOIN GARANTIAS_MES AS B ON A.CODCENTRAL=B.CODCENTRAL AND B.PRENDA>0

---------------------
---> HIPOTECA
---------------------
UPDATE A
SET A.HIPOTECA=CASE WHEN B.CODCENTRAL IS NULL THEN 'NO' ELSE 'SI' END
FROM PD_DECRECIENTE_JUDICIAL AS A
LEFT JOIN GARANTIAS_MES AS B ON A.CODCENTRAL=B.CODCENTRAL AND B.HIPOTECA>0


---/*------------------------------*/---
-----CREACIÓN DE TABLA #PROCESOS-------
---/*------------------------------*/---
If OBJECT_ID('tempdb..#TMP_SAEAEDTPCT') IS NOT NULL DROP TABLE #TMP_SAEAEDTPCT
SELECT *
INTO #TMP_SAEAEDTPCT
FROM XCOM_SAEAEDTPCT
WHERE FECHADATOS=(SELECT MAX(FECHADATOS) FROM XCOM_SAEAEDTPCT)


CREATE TABLE #PROCESOS
(CONTRATO VARCHAR (18),NROPROCESO NVARCHAR(20),MAXFECFASE DATETIME, TIPOPROC VARCHAR(10),CODFASE varchar(10))

INSERT INTO #PROCESOS
select distinct A.CONTRATO, A.NROPROCESO, b.MAXFECFASE, a.TIPOPROC , null
from #TMP_SAEAEDTPCT AS A JOIN (SELECT CONTRATO, numproc, MAX(FECFASE) AS MAXFECFASE
FROM #TMP_SAEDTFSS where FECFASE<GETDATE()
GROUP BY CONTRATO, numproc )B
ON  A.CONTRATO=B.CONTRATO
WHERE A.NROPROCESO=b.numproc


UPDATE A
SET A.CODFASE=B.CODFASE
FROM #PROCESOS AS A ,#TMP_SAEDTFSS  AS B
WHERE A.CONTRATO=B.CONTRATO
AND A.MAXFECFASE=B.FECFASE
AND A.NROPROCESO=B.NUMPROC


---/*------------------------------*/---
-----CREACIÓN DE TABLA #FASES-------
---/*------------------------------*/---

If OBJECT_ID('tempdb..#FASES') IS NOT NULL DROP TABLE #FASES
CREATE TABLE #FASES
(CONTRATO VARCHAR (18),NUMPROC NVARCHAR(20),CODFASE VARCHAR(4), FECFASE DATETIME, PROCESO VARCHAR(6),FECHA_DEMANDA datetime)

INSERT INTO #FASES
SELECT CONTRATO, NUMPROC, CODFASE, FECFASE, NULL, null
FROM #TMP_SAEDTFSS

UPDATE A
SET A.PROCESO=B.TIPOPROC
FROM #FASES AS A , #PROCESOS AS B
WHERE A.CONTRATO=B.CONTRATO
AND  A.NUMPROC=B.NROPROCESO

UPDATE A
SET A.FECHA_DEMANDA=CASE
WHEN A.PROCESO='EG' AND A.CODFASE='025' THEN A.FECFASE
WHEN A.PROCESO='EG' AND A.CODFASE='030' THEN A.FECFASE
WHEN A.PROCESO='AB' AND A.CODFASE='025' THEN A.FECFASE
WHEN A.PROCESO='AB' AND A.CODFASE='030' THEN A.FECFASE
WHEN A.PROCESO='ABCH' AND A.CODFASE='030' THEN A.FECFASE
WHEN A.PROCESO='CO' AND A.CODFASE='025' THEN A.FECFASE
WHEN A.PROCESO='CO' AND A.CODFASE='030' THEN A.FECFASE
WHEN A.PROCESO='COCH' AND A.CODFASE='030' THEN A.FECFASE
WHEN A.PROCESO='EC' AND A.CODFASE='080' THEN A.FECFASE
WHEN A.PROCESO='ECCH' AND A.CODFASE='080' THEN A.FECFASE
WHEN A.PROCESO='EGCH' AND A.CODFASE='030' THEN A.FECFASE
WHEN A.PROCESO='EJ' AND A.CODFASE='030' THEN A.FECFASE
WHEN A.PROCESO='EJ' AND A.CODFASE='025' THEN A.FECFASE
WHEN A.PROCESO='EJCH' AND A.CODFASE='030' THEN A.FECFASE
WHEN A.PROCESO='EL' AND A.CODFASE='030' THEN A.FECFASE
WHEN A.PROCESO='EL' AND A.CODFASE='025' THEN A.FECFASE
WHEN A.PROCESO='ELCH' AND A.CODFASE='030' THEN A.FECFASE
WHEN A.PROCESO='PA' AND A.CODFASE='050' THEN A.FECFASE
WHEN A.PROCESO='PA' AND A.CODFASE='060' THEN A.FECFASE
WHEN A.PROCESO='SU' AND A.CODFASE='025' THEN A.FECFASE
WHEN A.PROCESO='SU' AND A.CODFASE='030' THEN A.FECFASE
WHEN A.PROCESO='SUCH' AND A.CODFASE='030' THEN A.FECFASE
ELSE '' END
FROM #FASES AS A


------------------------
---> CON_PROCESO EN SAE
------------------------
update a
set a.CON_PROCESO=CASE WHEN B.CONTRATO IS NULL THEN 'NO' ELSE 'SI' END
from PD_DECRECIENTE_JUDICIAL A
LEFT JOIN #PROCESOS B ON A.CONTRATO=B.CONTRATO

---------------------------------
---> BIEN LEASING
---------------------------------
update a
set a.TIPO_LEASING=CASE WHEN b.TIPO_BIEN='TE' THEN 'TERRENO'
WHEN b.TIPO_BIEN='MA' THEN 'MAQUINARIA'
WHEN b.TIPO_BIEN='ED' THEN 'EDIFICIO'
WHEN b.TIPO_BIEN='MO' THEN 'MOBILIARIO'
WHEN b.TIPO_BIEN='TR' THEN 'TRANSPORTE'
ELSE 'NO UBICADO' END
from PD_DECRECIENTE_JUDICIAL A
inner join MLNEW2.RIE_PYMES.DBO.MAE_LEASING B on a.CONTRATO=b.CONTRATO collate Modern_Spanish_CI_AS

---------------------------------
---> LIMA PROV   >>SE CAMBIO TERRITORIOS2017
---------------------------------
UPDATE A
SET A.LIMA_PROV=CASE
WHEN A.TERRITORIO IN ('DIVISION NORTE','DIVISION CENTRO ORIENTE','DIVISION SUR')  THEN 'PROVINCIA'
ELSE 'LIMA'  END
FROM PD_DECRECIENTE_JUDICIAL  AS A


----------------------MHV_BASE_DOCUMENTOS_DIARIO-----------
---> TIPO DE GARANTIA
---------------------------------
UPDATE A
SET A.TIPO_GARANTIA=CASE
WHEN (A.HIPOTECA='SI' OR A.PRENDA='SI' OR A.LIQUIDAS='SI') THEN 'CON GTIAS'
WHEN (A.FLAG_FIANZA='SI' AND A.TIPO_GARANTIA IS NULL)  THEN 'CON FZAS'
ELSE 'SIN GTIAS' END
FROM PD_DECRECIENTE_JUDICIAL AS A

---------------------------------
---> PROVISIONES
---------------------------------

update a
set a.TASA_PROV_DEUDA=B.PROVISION/A.RIESGO_TOTAL
from PD_DECRECIENTE_JUDICIAL as a , (SELECT DISTINCT CODCENTRAL, SUM(PROVISIONES) AS PROVISION
FROM PD_DECRECIENTE_JUDICIAL
GROUP BY CODCENTRAL) B
WHERE A.CODCENTRAL=B.CODCENTRAL
AND A.RIESGO_TOTAL>0


/*
ALTER TABLE PD_DECRECIENTE_JUDICIAL   ADD CLASIFICACION  VARCHAR(4)
ALTER TABLE PD_DECRECIENTE_JUDICIAL   ADD PROV_100  VARCHAR(10)
ALTER TABLE PD_DECRECIENTE_JUDICIAL   ADD RANGO_DEUDA  VARCHAR(10)
ALTER TABLE PD_DECRECIENTE_JUDICIAL   ADD VENTA  VARCHAR(40)
ALTER TABLE PD_DECRECIENTE_JUDICIAL   ADD DA INT
ALTER TABLE PD_DECRECIENTE_JUDICIAL ADD VENTA  VARCHAR(40)

*/
---> PROV_100
UPDATE A
SET A.PROV_100=case
when A.TASA_PROV_DEUDA>=1 then 'SI'
ELSE 'NO' END
from PD_DECRECIENTE_JUDICIAL as a

---> RANGO_DEUDA
UPDATE A
SET A.RANGO_DEUDA=case
when A.RIESGO_TOTAL<=50000 then '<50M'
when A.RIESGO_TOTAL BETWEEN 50000 AND 100000 then '50M-100M'
when A.RIESGO_TOTAL BETWEEN 100000 AND 200000 then '100M-200M'
when A.RIESGO_TOTAL >= 200000 then '>200M'
ELSE 'NO' END
from PD_DECRECIENTE_JUDICIAL as a


UPDATE A
SET A.VENTA=CASE
WHEN A.CLASIFICACION=4 AND PROV_100='SI'  AND DA>=120 THEN 'SI VENTA'
ELSE 'NO VENTA' END
FROM PD_DECRECIENTE_JUDICIAL AS A

---------------------------------
---> CONTRATOS RELACIONADOS
---------------------------------
If OBJECT_ID('tempdb..#JUDICIAL') IS NOT NULL DROP TABLE #JUDICIAL
CREATE TABLE #JUDICIAL
(RELACIONADOS VARCHAR (18),ORIGEN VARCHAR (18), PRESTAMOS VARCHAR(18),CODCENTRAL VARCHAR(10))

INSERT INTO #JUDICIAL
SELECT DISTINCT RELACIONADOS, ORIGEN, NULL, NULL FROM MLNEW2.RIE_INTPER.DBO.MHV_RELACIONADOS
WHERE RELACIONADOS IN (SELECT DISTINCT CONTRATO collate Modern_Spanish_CI_AS FROM PD_DECRECIENTE_JUDICIAL)


UPDATE A
SET A.PRESTAMOS=b.PRODUCTO_FINAL,  A.CODCENTRAL=b.CODCENTRAL
FROM #JUDICIAL AS A, MLNEW2.RIE_INTPER.DBO.MHV_BNEGOCIO_202111 as B--cambiar mensual
WHERE A.ORIGEN=B.CONTRATO collate Modern_Spanish_CI_AS


-----------------------------------------------
----NUEVA SEGMENTACION PARA SECURE & UNSECURED
-----------------------------------------------
---> 'EMPRESAS'
UPDATE A
SET A.SEGMENTACION='EMPRESAS_CON_GTIA'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.CODCENTRAL IN (SELECT DISTINCT CODCENTRAL FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE (A.FLAG_GIA_REAL='SI' OR A.FLAG_GIA_FIADOR='SI'))
AND A.[SEGMENTO DE NEGOCIO] NOT IN ('PARTICULARES','PYME','BEC-RED')

UPDATE A
SET A.SEGMENTACION='EMPRESAS_CON_GTIA'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.CODCENTRAL IN (SELECT DISTINCT CODCENTRAL FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.PRODUCTO in ('LEASING','HIPOTECARIO'))
AND A.[SEGMENTO DE NEGOCIO] NOT IN ('PARTICULARES','PYME','BEC-RED')
AND A.SEGMENTACION IS NULL

UPDATE A
SET A.SEGMENTACION='EMPRESAS_SIN_GTIA'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.[SEGMENTO DE NEGOCIO] NOT IN ('PARTICULARES','PYME','BEC-RED')
AND A.SEGMENTACION IS NULL

-------------Nuevo: Empresas Minoristas-BEC RED 28/01/21

UPDATE A
SET A.SEGMENTACION='EMPRESAS_MIN_CON_GTIA'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.CODCENTRAL IN (SELECT DISTINCT CODCENTRAL FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE (A.FLAG_GIA_REAL='SI' OR A.FLAG_GIA_FIADOR='SI'))
AND A.[SEGMENTO DE NEGOCIO] IN ('BEC-RED')

UPDATE A
SET A.SEGMENTACION='EMPRESAS_MIN_CON_GTIA'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.CODCENTRAL IN (SELECT DISTINCT CODCENTRAL FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.PRODUCTO in ('LEASING','HIPOTECARIO'))
AND A.[SEGMENTO DE NEGOCIO] IN ('BEC-RED')
AND A.SEGMENTACION IS NULL

UPDATE A
SET A.SEGMENTACION='EMPRESAS_MIN_SIN_GTIA'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.[SEGMENTO DE NEGOCIO] IN ('BEC-RED')
AND A.SEGMENTACION IS NULL
--------------------------------------------------------------------------


---> 'PYME LEASING COMO MONOPRODUCTO'
UPDATE A
SET A.SEGMENTACION='PYME_LEASING'
FROM PD_DECRECIENTE_JUDICIAL A--PD_DECRECIENTE_JUDICIAL AS A
WHERE A.CODCENTRAL IN (SELECT DISTINCT A.CODCENTRAL    ---> PERMITE IDENTIFICAR  ALOS CLIENTES MONOPRODUCTO LEASING EN BANCO (INCLUYE VIGENTES)
FROM  PD_UNIVERSO_DIARIO   AS A
INNER JOIN (select DISTINCT CODCENTRAL, COUNT(DISTINCT PRODUCTO) AS NRO
FROM PD_UNIVERSO_DIARIO
GROUP BY CODCENTRAL) B ON A.CODCENTRAL=B.CODCENTRAL
WHERE B.NRO='1'  AND A.PRODUCTO='LEASING'  AND SEGMENTO_RIESGO IN ('PARTICULARES','PYME') )
AND A.[SEGMENTO DE NEGOCIO] IN ('PARTICULARES','PYME')
AND A.SEGMENTACION IS NULL

---> 'PYME CON GTIA'
UPDATE A
SET A.SEGMENTACION='PYME_CON_GTIA'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.CODCENTRAL IN (SELECT DISTINCT CODCENTRAL FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE (A.FLAG_GIA_REAL='SI' OR A.FLAG_GIA_FIADOR='SI') AND [SEGMENTO DE NEGOCIO]='PYME')
AND A.[SEGMENTO DE NEGOCIO] IN ('PARTICULARES','PYME')
AND A.SEGMENTACION IS NULL

-----> COMPLEMENTOS PYME CON GTIA
UPDATE A
SET A.SEGMENTACION='PYME_CON_GTIA'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.CODCENTRAL IN (SELECT DISTINCT CODCENTRAL
FROM PD_UNIVERSO_DIARIO
WHERE CODCENTRAL IN (SELECT DISTINCT CODCENTRAL
FROM PD_UNIVERSO_DIARIO AS A
WHERE A.PRODUCTO IN ('HIPOTECARIO'))
AND SEGMENTO_RIESGO IN ('PYME'))
AND A.[SEGMENTO DE NEGOCIO] IN ('PARTICULARES','PYME')
AND A.SEGMENTACION IS NULL


---> 'PYME LEASING'
UPDATE A
SET A.SEGMENTACION='PYME_LEASING'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.CODCENTRAL IN (SELECT DISTINCT CODCENTRAL FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.PRODUCTO='LEASING')
AND A.[SEGMENTO DE NEGOCIO] IN ('PARTICULARES','PYME')
AND A.SEGMENTACION IS NULL

---> 'PYME SIN GARANTIA'
UPDATE A
SET A.SEGMENTACION='PYME_SIN_GTIA'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.CODCENTRAL IN (SELECT DISTINCT CODCENTRAL FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.SEGMENTACION IS NULL AND [SEGMENTO DE NEGOCIO]='PYME')
AND A.[SEGMENTO DE NEGOCIO] IN ('PARTICULARES','PYME')
AND A.SEGMENTACION IS NULL


----------------------------------
---> 'CLIENTE HIPOTECARIO'
----------------------------------
UPDATE A
SET A.SEGMENTACION='HIPOTECARIO'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.CODCENTRAL IN (SELECT DISTINCT CODCENTRAL FROM PD_DECRECIENTE_JUDICIAL
WHERE producto='HIPOTECARIO')
AND A.[SEGMENTO DE NEGOCIO] IN ('PARTICULARES','PYME')
AND A.SEGMENTACION IS NULL


-----> COMPLEMENTOS
UPDATE A
SET A.SEGMENTACION='HIPOTECARIO'
FROM  PD_DECRECIENTE_JUDICIAL AS A
WHERE A.HIPOTECA='SI'  AND  A.SEGMENTACION IS NULL
AND A.[SEGMENTO DE NEGOCIO] IN ('PARTICULARES','PYME')

----------------------------------
---> 'CLIENTE VEHICULAR'
----------------------------------
---> CLIENTES CON PRODUCTOS VEHICULAR
UPDATE A
SET A.SEGMENTACION='VEHICULAR'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.CODCENTRAL IN
(SELECT DISTINCT CODCENTRAL FROM PD_DECRECIENTE_JUDICIAL  AS A
WHERE producto='PRÉSTAMO VEHICULAR')
AND A.[SEGMENTO DE NEGOCIO] IN ('PARTICULARES','PYME')
AND A.SEGMENTACION IS NULL

---------------------
--MASIVOS
---------------------
UPDATE A
SET A.SEGMENTACION='MASIVOS'
FROM PD_DECRECIENTE_JUDICIAL AS A
WHERE A.[SEGMENTO DE NEGOCIO] IN ('PARTICULARES','PYME')
AND A.SEGMENTACION IS NULL


-----------------------------------
--GRUPOS  NO DATOS POR EL MOMENTO
-----------------------------------

UPDATE A
SET A.GRUPO=CASE WHEN A.SEGMENTACION IN ('EMPRESAS_CON_GTIA','EMPRESAS_MIN_CON_GTIA','HIPOTECARIO','PYME_CON_GTIA','PYME_LEASING') THEN 'SECURED'
WHEN A.SEGMENTACION IN ('EMPRESAS_SIN_GTIA','EMPRESAS_MIN_SIN_GTIA','PYME_SIN_GTIA','VEHICULAR','MASIVOS') THEN 'UNSECURED'
END
FROM PD_DECRECIENTE_JUDICIAL A


------ Nueva Asignacion Marzo 2020 --------------------------
-- Cambio Carmen Quispe Tabla Nueva Estructura
UPDATE A
SET A.GESTOR=CASE WHEN A.[SEGMENTO DE NEGOCIO] IN ('BEC','CIB') THEN B.GESTOR2 ---Cambio 2021 --LINE2947
ELSE B.GESTOR1 END
FROM PD_DECRECIENTE_JUDICIAL A
INNER JOIN pd_territorio_gestor B  --PD_TERRITORIO_GESTOR
ON A.GRUPO=B.CARTERA AND A.TERRITORIO=B.TERRITORIO



------------------------------------------
---MARCA RFA
------------------------------------------

UPDATE A
SET A.[ESTUDIO ASIGNADO]='GESTION INTERNA: CASO RFA'
FROM PD_DECRECIENTE_JUDICIAL AS A INNER JOIN RFA AS B
ON A.CODCENTRAL=B.CODCENTRAL
WHERE A.[ESTUDIO ASIGNADO] IS NULL


---------------------------------------------
--> PD_DECRECIENTE_JUDICIAL_RELOADED
---------------------------------------------
delete from PD_DECRECIENTE_JUDICIAL_RELOADED

insert into PD_DECRECIENTE_JUDICIAL_RELOADED
select distinct E.CODCENTRAL,E.contrato as [CONTRATO],
C.NROPROCESO, c.codfase as [Código],K.CODDATO AS COD_ESTUDIO,
C.TIPOPROC as [Tipo Proc],P.EMBARGO,I.DESC_PROCESO as [Procedimiento],
I.DESCRIPCION as [FASE],c.MAXFECFASE as [Fecha_Fase],
---[Días por Vencer] =case
---when I.DIAS_PER=99999 then 0
---when I.DIAS_PER<>99999 then cast(I.DIAS_PER AS numeric(10)) -convert(numeric(10),getdate() - convert(numeric(10),(cast(c.fecfase as datetime)-1)))
----else '' end ,
K.FASIGNA as [Fecha de Asignación],  -------------------cambio 21/09/2021 de FECHA_M a FASIGNA
F.NROEXPJUDI,
F.JUZGADO as [N° Juzgado],
---- F.ESTADOEXP, F.CIUDAD,
M.PROVINCIA, M.CIUDAD, M.PLAZA
from PD_DECRECIENTE_JUDICIAL AS E
LEFT JOIN  (SELECT * FROM #PROCESOS) C
ON E.contrato=C.CONTRATO

LEFT JOIN (
SELECT G.contrato,G.NROPROCESO, G.TIPOPROC, G.ESTADOEXP, G.NROEXPJUDI, G.JUZGADO, G.CIUDAD
from #TMP_SAEAEDTPCT AS G
--WHERE G.contrato='001109709600013507'
) F
ON (c.NROPROCESO=F.NROPROCESO AND E.contrato=F.CONTRATO)

LEFT JOIN (
SELECT H.CLAVE, H.DESC_PROCESO, H.DESCRIPCION,H.DIAS_PER,H.CODIGO_SGTE,H.DESCRIPCION_SGTE,H.DIAS_PER_SGTE
from FASES_SAE AS H
) I
ON (LTRIM(RTRIM(C.TIPOPROC))+LTRIM(RTRIM(c.codfase)))=I.CLAVE

LEFT JOIN (
SELECT J.CONTRATO, J.FASIGNA,J.CODDATO -------------------cambio 21/09/2021 de FECHA_M a FASIGNA
from XCOM_ASIGNACION_ESTUDIOS_HOY AS J
) K
ON E.contrato=K.CONTRATO

LEFT JOIN (
SELECT L.CLAVE,L.PROVINCIA, L.CIUDAD, L.PLAZA
from CODIGO_CIUDAD AS L
) M
ON LTRIM(RTRIM(F.ESTADOEXP))+LTRIM(RTRIM(F.CIUDAD))=M.CLAVE

LEFT JOIN
(SELECT DISTINCT CONTRATO,'EMBARGO' AS EMBARGO FROM #TMP_SAEAEDTPCT
WHERE TIPOPROC='CA') P
ON  E.contrato= P.CONTRATO
WHERE E.[SALDO JUDICIAL]>0

---------------------------------------------
--> PD_TABLA_PROCESO
---------------------------------------------
delete from PD_TABLA_PROCESO

insert into PD_TABLA_PROCESO
SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY CONTRATO DESC) AS Row, CODCENTRAL,contrato
,('Proceso:'+ '  '+PROCEDIMIENTO+' /  '+'Fase:'+' '+FASE+' / '+ 'Fecha Fase:'+'  '+cast(cast(FECHA_FASE as smalldatetime) as varchar)+' / '+ 'Nª Expediente:'+'  '+NROEXPJUDI+' / '+'N° Juzgado:'+' '+[N° Juzgado]+' / '+'Provinca Juzgado:'+'  '+ PROVINCIA+'
/ '+'Ciudad Juzgado:'+'  '+ CIUDAD+' / '+'Plaza Juzgado:'+ PLAZA) as DATOS
FROM PD_DECRECIENTE_JUDICIAL_RELOADED
group by CONTRATO, codcentral, PROCEDIMIENTO, FASE, FECHA_FASE,NROEXPJUDI,[N° Juzgado],PROVINCIA, CIUDAD,PLAZA

---------------------------------------------
--> PROCESOS JUDICIALES
---------------------------------------------

UPDATE A
SET A.PROCESO_N1=CAST(B.DATOS AS VARCHAR(MAX))
FROM PD_DECRECIENTE_JUDICIAL AS A  , PD_TABLA_PROCESO AS B
WHERE A.CONTRATO=B.CONTRATO
AND B.ROW=1

UPDATE A
SET A.PROCESO_N2=CAST(B.DATOS AS VARCHAR(MAX))
FROM PD_DECRECIENTE_JUDICIAL AS A  , PD_TABLA_PROCESO AS B
WHERE A.CONTRATO=B.CONTRATO
AND B.ROW=2


UPDATE A
SET A.PROCESO_N3=CAST(B.DATOS AS VARCHAR(MAX))
FROM PD_DECRECIENTE_JUDICIAL AS A  , PD_TABLA_PROCESO AS B
WHERE A.CONTRATO=B.CONTRATO
AND B.ROW=3


UPDATE A
SET A.PROCESO_N4=CAST(B.DATOS AS VARCHAR(MAX))
FROM PD_DECRECIENTE_JUDICIAL AS A  , PD_TABLA_PROCESO AS B
WHERE A.CONTRATO=B.CONTRATO
AND B.ROW=4


UPDATE A
SET A.PROCESO_N5=CAST(B.DATOS AS VARCHAR(MAX))
FROM PD_DECRECIENTE_JUDICIAL AS A  , PD_TABLA_PROCESO AS B
WHERE A.CONTRATO=B.CONTRATO
AND B.ROW=5


UPDATE A
SET A.PROCESO_N6=CAST(B.DATOS AS VARCHAR(MAX))
FROM PD_DECRECIENTE_JUDICIAL AS A  , PD_TABLA_PROCESO AS B
WHERE A.CONTRATO=B.CONTRATO
AND B.ROW=6

UPDATE A
SET A.PROCESO_N7=CAST(B.DATOS AS VARCHAR(MAX))
FROM PD_DECRECIENTE_JUDICIAL AS A  , PD_TABLA_PROCESO AS B
WHERE A.CONTRATO=B.CONTRATO
AND B.ROW=7

---------------
---EMBARGO
---------------
UPDATE A
SET A.EMBARGO=B.EMBARGO
FROM PD_DECRECIENTE_JUDICIAL AS A
INNER JOIN PD_DECRECIENTE_JUDICIAL_RELOADED AS B
ON A.CONTRATO=B.CONTRATO

------------------------
---FECHA DE ASIGNACIÓN
------------------------
UPDATE A
SET A.FECHA_ASIGNACION=B.[Fecha de Asignación]
FROM PD_DECRECIENTE_JUDICIAL AS A
INNER JOIN PD_DECRECIENTE_JUDICIAL_RELOADED AS B
ON A.CONTRATO=B.CONTRATO

-------------------------
---> FLAG_MIVIVIENDA
------------------------
UPDATE A
SET A.FLAG_MIVIVIENDA=CASE WHEN B.CONTRATO IS NULL THEN 'NO' ELSE 'SI' END
FROM PD_DECRECIENTE_JUDICIAL AS A
LEFT JOIN (SELECT CONTRATO FROM PD_UNIVERSO_DIARIO WHERE CTA_CTBL_PIVOT LIKE '14_1_42_%' or
CTA_CTBL_PIVOT LIKE '14_4_42_%' or CTA_CTBL_PIVOT LIKE '14_5_4192_%' or
CTA_CTBL_PIVOT LIKE '14_5_42_%'or CTA_CTBL_PIVOT LIKE '14_6_42_%' or
CTA_CTBL_PIVOT LIKE '14_6_4192_%') AS B
ON A.CONTRATO=B.CONTRATO

-------------------------
---> UGA
------------------------
UPDATE A
SET A.uga=b.uga
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_DECRECIENTE_DIARIO AS B
WHERE A.CONTRATO=LEFT(B.CONTRATO,8)+RIGHT(B.CONTRATO,10)


-------------------
---> GARANTIAS
-------------------
UPDATE A
SET A.VAL_REAL_HIPOTECA=ISNULL(B.VRealizacionPEN,0.00)
FROM PD_DECRECIENTE_JUDICIAL A
LEFT JOIN PD_GARANTIAS_REAL_MES B ON A.CODCENTRAL=B.C_CENT_CLIE AND B.TIPO_GAR='HIPOTECA'

UPDATE A
SET A.VAL_REAL_PRENDA=ISNULL(B.VRealizacionPEN,0.00)
FROM PD_DECRECIENTE_JUDICIAL A
LEFT JOIN PD_GARANTIAS_REAL_MES B ON A.CODCENTRAL=B.C_CENT_CLIE AND B.TIPO_GAR='PRENDA'


--SELECT C_CENT_CLIE,COUNT(*)
--FROM PD_GARANTIAS_REAL_MES
--GROUP BY C_CENT_CLIE
--HAVING COUNT(*)>1



UPDATE A
SET A.GARANTIA_1=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B--VALIDAR ANTIGUERDAD DE LA BASE
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='1'



UPDATE A
SET A.GARANTIA_2=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='2'


UPDATE A
SET A.GARANTIA_3=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A ,PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='3'


UPDATE A
SET A.GARANTIA_4=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='4'



UPDATE A
SET A.GARANTIA_5=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='5'



UPDATE A
SET A.GARANTIA_6=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='6'



UPDATE A
SET A.GARANTIA_7=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='7'


UPDATE A
SET A.GARANTIA_8=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='8'



UPDATE A
SET A.GARANTIA_9=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='9'



UPDATE A
SET A.GARANTIA_10=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='10'


UPDATE A
SET A.GARANTIA_11=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='11'


UPDATE A
SET A.GARANTIA_12=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='12'



UPDATE A
SET A.GARANTIA_13=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='13'



UPDATE A
SET A.GARANTIA_14=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='14'



UPDATE A
SET A.GARANTIA_15=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='15'



UPDATE A
SET A.GARANTIA_16=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='16'



UPDATE A
SET A.GARANTIA_17=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='17'


UPDATE A
SET A.GARANTIA_18=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='18'



UPDATE A
SET A.GARANTIA_19=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='19'


UPDATE A
SET A.GARANTIA_20=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='20'


UPDATE A
SET A.GARANTIA_21=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='21'


UPDATE A
SET A.GARANTIA_22=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='22'



UPDATE A
SET A.GARANTIA_23=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='23'


UPDATE A
SET A.GARANTIA_24=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='24'


UPDATE A
SET A.GARANTIA_25=B.GTIA
FROM PD_DECRECIENTE_JUDICIAL AS A , PD_hipoteca_data_3    AS B
WHERE A.CODCENTRAL=B.C_CENT_CLIE
AND B.Row='25'

--------------------------------------------
---- > TABLA DE OBSERVACIONES
--------------------------------------------
--> CREAR #tabla
If OBJECT_ID('tempdb..#tabla') IS NOT NULL DROP TABLE #tabla
CREATE TABLE #tabla
(contrato VARCHAR (18),fechaobs datetime, obs VARCHAR(80),seq bigint )

insert into #tabla
SELECT CONTRATO,fechaobs,ltrim(rtrim(obs)) as obs ,
ROW_NUMBER() OVER (PARTITION BY year(fechaobs),month(fechaobs),day(fechaobs) ORDER BY fechaobs ) as seq
FROM XCOM_AE_Observaciones_HOY
where contrato in (select distinct contrato from PD_UNIVERSO_DIARIO)


--> CREAR #tabla1
If OBJECT_ID('tempdb..#tabla1') IS NOT NULL DROP TABLE #tabla1

CREATE TABLE #tabla1
(contrato VARCHAR (18),
fechaobs datetime,[1] VARCHAR (80),[2] VARCHAR (80),[3] VARCHAR (80),[4] VARCHAR (80),[5] VARCHAR (80),[6] VARCHAR (80),[7] VARCHAR (80),[8] VARCHAR (80),[9] VARCHAR (80),[10] VARCHAR (80),
[11] VARCHAR (80),[12] VARCHAR (80),[13] VARCHAR (80),[14] VARCHAR (80),[15] VARCHAR (80),[16] VARCHAR (80),[17] VARCHAR (80),[18] VARCHAR (80),[19] VARCHAR (80),[20] VARCHAR (80),
[21] VARCHAR (80),[22] VARCHAR (80),[23] VARCHAR (80),[24] VARCHAR (80),[25] VARCHAR (80),[26] VARCHAR (80),[27] VARCHAR (80),[28] VARCHAR (80),[29] VARCHAR (80),[30] VARCHAR (80),
[31] VARCHAR (80),[32] VARCHAR (80),[33] VARCHAR (80),[34] VARCHAR (80),[35] VARCHAR (80),[36] VARCHAR (80),[37] VARCHAR (80),[38] VARCHAR (80),[39] VARCHAR (80),[40] VARCHAR (80),
[41] VARCHAR (80),[42] VARCHAR (80),[43] VARCHAR (80),[44] VARCHAR (80),[45] VARCHAR (80),[46] VARCHAR (80),[47] VARCHAR (80),[48] VARCHAR (80),[49] VARCHAR (80),[50] VARCHAR (80),
[51] VARCHAR (80),[52] VARCHAR (80),[53] VARCHAR (80),[54] VARCHAR (80),[55] VARCHAR (80),[56] VARCHAR (80),[57] VARCHAR (80),[58] VARCHAR (80),[59] VARCHAR (80),[60] VARCHAR (80),
[61] VARCHAR (80),[62] VARCHAR (80),[63] VARCHAR (80),[64] VARCHAR (80),[65] VARCHAR (80),[66] VARCHAR (80),[67] VARCHAR (80),[68] VARCHAR (80),[69] VARCHAR (80),[70] VARCHAR (80),
[71] VARCHAR (80),[72] VARCHAR (80),[73] VARCHAR (80),[74] VARCHAR (80),[75] VARCHAR (80),[76] VARCHAR (80),[77] VARCHAR (80),[78] VARCHAR (80),[79] VARCHAR (80),[80] VARCHAR (80),
[81] VARCHAR (80),[82] VARCHAR (80),[83] VARCHAR (80),[84] VARCHAR (80),[85] VARCHAR (80),[86] VARCHAR (80),[87] VARCHAR (80),[88] VARCHAR (80),[89] VARCHAR (80),[90] VARCHAR (80),
[91] VARCHAR (80),[92] VARCHAR (80),[93] VARCHAR (80),[94] VARCHAR (80),[95] VARCHAR (80),[96] VARCHAR (80),[97] VARCHAR (80),[98] VARCHAR (80),[99] VARCHAR (80),[100] VARCHAR (80),
[101] VARCHAR (80),[102] VARCHAR (80),[103] VARCHAR (80),[104] VARCHAR (80),[105] VARCHAR (80),[106] VARCHAR (80),[107] VARCHAR (80),[108] VARCHAR (80),[109] VARCHAR (80),[110] VARCHAR (80),
[111] VARCHAR (80),[112] VARCHAR (80),[113] VARCHAR (80),[114] VARCHAR (80),[115] VARCHAR (80),[116] VARCHAR (80),[117] VARCHAR (80),[118] VARCHAR (80),[119] VARCHAR (80),[120] VARCHAR (80),
[121] VARCHAR (80),[122] VARCHAR (80),[123] VARCHAR (80),[124] VARCHAR (80),[125] VARCHAR (80),[126] VARCHAR (80),[127] VARCHAR (80),[128] VARCHAR (80),[129] VARCHAR (80),[130] VARCHAR (80),
[131] VARCHAR (80),[132] VARCHAR (80),[133] VARCHAR (80),[134] VARCHAR (80),[135] VARCHAR (80),[136] VARCHAR (80),[137] VARCHAR (80),[138] VARCHAR (80),[139] VARCHAR (80),[140] VARCHAR (80),
[141] VARCHAR (80),[142] VARCHAR (80),[143] VARCHAR (80),[144] VARCHAR (80),[145] VARCHAR (80),[146] VARCHAR (80),[147] VARCHAR (80),[148] VARCHAR (80),[149] VARCHAR (80),[150] VARCHAR (80),
[151] VARCHAR (80),[152] VARCHAR (80),[153] VARCHAR (80),[154] VARCHAR (80),[155] VARCHAR (80),[156] VARCHAR (80),[157] VARCHAR (80),[158] VARCHAR (80),[159] VARCHAR (80),[160] VARCHAR (80),
[161] VARCHAR (80),[162] VARCHAR (80),[163] VARCHAR (80),[164] VARCHAR (80),[165] VARCHAR (80),[166] VARCHAR (80),[167] VARCHAR (80),[168] VARCHAR (80),[169] VARCHAR (80),[170] VARCHAR (80),
[171] VARCHAR (80),[172] VARCHAR (80),[173] VARCHAR (80),[174] VARCHAR (80),[175] VARCHAR (80),[176] VARCHAR (80),[177] VARCHAR (80),[178] VARCHAR (80),[179] VARCHAR (80),[180] VARCHAR (80),
[181] VARCHAR (80),[182] VARCHAR (80),[183] VARCHAR (80),[184] VARCHAR (80),[185] VARCHAR (80),[186] VARCHAR (80),[187] VARCHAR (80),[188] VARCHAR (80),[189] VARCHAR (80),[190] VARCHAR (80),
[191] VARCHAR (80),[192] VARCHAR (80),[193] VARCHAR (80),[194] VARCHAR (80),[195] VARCHAR (80),[196] VARCHAR (80),[197] VARCHAR (80),[198] VARCHAR (80),[199] VARCHAR (80),[200] VARCHAR (80),
[201] VARCHAR (80),[202] VARCHAR (80),[203] VARCHAR (80),[204] VARCHAR (80),[205] VARCHAR (80),[206] VARCHAR (80),[207] VARCHAR (80),[208] VARCHAR (80),[209] VARCHAR (80),[210] VARCHAR (80),
[211] VARCHAR (80),[212] VARCHAR (80),[213] VARCHAR (80),[214] VARCHAR (80),[215] VARCHAR (80),[216] VARCHAR (80),[217] VARCHAR (80),[218] VARCHAR (80),[219] VARCHAR (80),[220] VARCHAR (80),
[221] VARCHAR (80),[222] VARCHAR (80),[223] VARCHAR (80),[224] VARCHAR (80),[225] VARCHAR (80),[226] VARCHAR (80),[227] VARCHAR (80),[228] VARCHAR (80),[229] VARCHAR (80),[230] VARCHAR (80),
[231] VARCHAR (80),[232] VARCHAR (80),[233] VARCHAR (80),[234] VARCHAR (80),[235] VARCHAR (80),[236] VARCHAR (80),[237] VARCHAR (80),[238] VARCHAR (80),[239] VARCHAR (80),[240] VARCHAR (80),
[241] VARCHAR (80),[242] VARCHAR (80),[243] VARCHAR (80),[244] VARCHAR (80),[245] VARCHAR (80),[246] VARCHAR (80),[247] VARCHAR (80),[248] VARCHAR (80),[249] VARCHAR (80),[250] VARCHAR (80),
[251] VARCHAR (80),[252] VARCHAR (80),[253] VARCHAR (80),[254] VARCHAR (80),[255] VARCHAR (80),[256] VARCHAR (80),[257] VARCHAR (80),[258] VARCHAR (80),[259] VARCHAR (80),[260] VARCHAR (80),
[261] VARCHAR (80),[262] VARCHAR (80),[263] VARCHAR (80),[264] VARCHAR (80),[265] VARCHAR (80),[266] VARCHAR (80),[267] VARCHAR (80),[268] VARCHAR (80),[269] VARCHAR (80),[270] VARCHAR (80),
[271] VARCHAR (80),[272] VARCHAR (80),[273] VARCHAR (80),[274] VARCHAR (80),[275] VARCHAR (80),[276] VARCHAR (80),[277] VARCHAR (80),[278] VARCHAR (80),[279] VARCHAR (80),[280] VARCHAR (80),
[281] VARCHAR (80),[282] VARCHAR (80),[283] VARCHAR (80),[284] VARCHAR (80),[285] VARCHAR (80),[286] VARCHAR (80),[287] VARCHAR (80),[288] VARCHAR (80),[289] VARCHAR (80),[290] VARCHAR (80),
[291] VARCHAR (80),[292] VARCHAR (80),[293] VARCHAR (80),[294] VARCHAR (80),[295] VARCHAR (80),[296] VARCHAR (80),[297] VARCHAR (80),[298] VARCHAR (80),[299] VARCHAR (80),[300] VARCHAR (80),
[301] VARCHAR (80),[302] VARCHAR (80),[303] VARCHAR (80),[304] VARCHAR (80),[305] VARCHAR (80),[306] VARCHAR (80),[307] VARCHAR (80),[308] VARCHAR (80),[309] VARCHAR (80),[310] VARCHAR (80))


insert into #tabla1 SELECT  * FROM #tabla
PIVOT (max(obs) FOR seq IN  (
[1],[2],[3],[4],[5],[6],[7],[8],[9],[10],
[11],[12],[13],[14],[15],[16],[17],[18],[19],[20],
[21],[22],[23],[24],[25],[26],[27],[28],[29],[30],
[31],[32],[33],[34],[35],[36],[37],[38],[39],[40],
[41],[42],[43],[44],[45],[46],[47],[48],[49],[50],
[51],[52],[53],[54],[55],[56],[57],[58],[59],[60],
[61],[62],[63],[64],[65],[66],[67],[68],[69],[70],
[71],[72],[73],[74],[75],[76],[77],[78],[79],[80],
[81],[82],[83],[84],[85],[86],[87],[88],[89],[90],
[91],[92],[93],[94],[95],[96],[97],[98],[99],[100],
[101],[102],[103],[104],[105],[106],[107],[108],[109],[110],
[111],[112],[113],[114],[115],[116],[117],[118],[119],[120],
[121],[122],[123],[124],[125],[126],[127],[128],[129],[130],
[131],[132],[133],[134],[135],[136],[137],[138],[139],[140],
[141],[142],[143],[144],[145],[146],[147],[148],[149],[150],
[151],[152],[153],[154],[155],[156],[157],[158],[159],[160],
[161],[162],[163],[164],[165],[166],[167],[168],[169],[170],
[171],[172],[173],[174],[175],[176],[177],[178],[179],[180],
[181],[182],[183],[184],[185],[186],[187],[188],[189],[190],
[191],[192],[193],[194],[195],[196],[197],[198],[199],[200],
[201],[202],[203],[204],[205],[206],[207],[208],[209],[210],
[211],[212],[213],[214],[215],[216],[217],[218],[219],[220],
[221],[222],[223],[224],[225],[226],[227],[228],[229],[230],
[231],[232],[233],[234],[235],[236],[237],[238],[239],[240],
[241],[242],[243],[244],[245],[246],[247],[248],[249],[250],
[251],[252],[253],[254],[255],[256],[257],[258],[259],[260],
[261],[262],[263],[264],[265],[266],[267],[268],[269],[270],
[271],[272],[273],[274],[275],[276],[277],[278],[279],[280],
[281],[282],[283],[284],[285],[286],[287],[288],[289],[290],
[291],[292],[293],[294],[295],[296],[297],[298],[299],[300],
[301],[302],[303],[304],[305],[306],[307],[308],[309],[310]
))AS unpvt
ORDER BY fechaobs DESC

--> CREAR #tabla2
If OBJECT_ID('tempdb..#tabla2') IS NOT NULL DROP TABLE #tabla2

CREATE TABLE #tabla2  (contrato VARCHAR (18),fechaobs datetime, observacion VARCHAR(max))

insert into #tabla2
select distinct contrato, fechaobs,
isnull([1],'')+isnull([2],'')+isnull([3],'')+isnull([4],'')+isnull([5],'')+isnull([6],'')+isnull([7],'')+isnull([8],'')+isnull([9],'')+isnull([10],'')
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
from #tabla1
order by 1 desc

If OBJECT_ID('tempdb..#OBSERVACIONES') IS NOT NULL DROP TABLE #OBSERVACIONES
SELECT *
INTO #OBSERVACIONES
FROM #tabla2

-------------------
---> OBSERVACIONES
-------------------
update a
set a.OBSERVACION_1=ltrim(rtrim(B.observacion))
from  PD_DECRECIENTE_JUDICIAL as a left join  (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
on  a.CONTRATO=b.contrato
where Row=1
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_2=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=2
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)




update a
set a.OBSERVACION_3=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=3
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_4=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=4
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_5=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=5
and a.CONTRATO in( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_6=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=6
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_7=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=7
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_8=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=8
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_9=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=9
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_10=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=10
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)

update a
set a.OBSERVACION_11=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,  observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=11
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_12=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=12
and a.CONTRATO in  ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)

update a
set a.OBSERVACION_13=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=13
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)

update a
set a.OBSERVACION_14=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=14
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)

update a
set a.OBSERVACION_15=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,  observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=15
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)

update a
set a.OBSERVACION_16=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=16
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)

update a
set a.OBSERVACION_17=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=17
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_18=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=18
and a.CONTRATO in  ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)



update a
set a.OBSERVACION_19=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,  observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=19
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_20=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=20
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_21=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=21
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)

update a
set a.OBSERVACION_22=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,  observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=22
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_23=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=23
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)

update a
set a.OBSERVACION_24=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,  observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=24
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_25=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,  observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=25
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)



update a
set a.OBSERVACION_26=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO, observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=26
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)



update a
set a.OBSERVACION_27=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,  observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=27
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_28=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,  observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=28
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)



update a
set a.OBSERVACION_29=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,  observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=29
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_30=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=30
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)



update a
set a.OBSERVACION_31=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=31
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)



update a
set a.OBSERVACION_32=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=32
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)




update a
set a.OBSERVACION_33=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=33
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)



update a
set a.OBSERVACION_34=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=34
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)



update a
set a.OBSERVACION_35=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=35
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_36=B.observacion
from  PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=36
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_37=B.observacion
from PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=37
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)



update a
set a.OBSERVACION_38=B.observacion
from PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=38
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)



update a
set a.OBSERVACION_39=B.observacion
from PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=39
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)


update a
set a.OBSERVACION_40=B.observacion
from PD_DECRECIENTE_JUDICIAL as a, (SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECHAOBS DESC) AS Row ,CONTRATO,observacion, FECHAOBS
from #OBSERVACIONES) b
where a.CONTRATO=b.contrato
and Row=40
and a.CONTRATO in ( select distinct CONTRATO from PD_DECRECIENTE_JUDICIAL)
------------------------------------------------------------------------------------------------------------------------------------------------------------

----> #TABLA1_F
If OBJECT_ID('tempdb..#TABLA1_F') IS NOT NULL DROP TABLE #TABLA1_F
CREATE TABLE #TABLA1_F
(contrato VARCHAR (18),NROPROCESO VARCHAR(20), CODFASE VARCHAR(20), FECFASE VARCHAR(20), TIPOPROC VARCHAR(20),DESCRIPCION_FASE VARCHAR(300),PROCEDIMIENTO VARCHAR(300),DETALLE VARCHAR(800) )

INSERT INTO #TABLA1_F
select distinct A.CONTRATO,a.NROPROCESO, B.CODFASE, b.FECFASE, a.TIPOPROC, NULL, NULL ,NULL
from #PROCESOS AS A , #FASEs  AS B
where A.CONTRATO=B.CONTRATO
and A.NROPROCESO=b.numproc

UPDATE A
SET A.DESCRIPCION_FASE=DESCRIPCION
FROM #TABLA1_F AS A , FASES_SAE AS  B
WHERE A.CODFASE=B.CODIGO
AND A.TIPOPROC=B.TIPOPROCESO

UPDATE A
SET A.PROCEDIMIENTO=DESC_PROCESO
FROM #TABLA1_F AS A , FASES_SAE AS  B
WHERE A.CODFASE=B.CODIGO
AND A.TIPOPROC=B.TIPOPROCESO

UPDATE A
SET A.DETALLE=CAST(FECFASE AS VARCHAR(40))+' Proceso: ' +PROCEDIMIENTO+' Fase:  '+DESCRIPCION_FASE
FROM #TABLA1_F AS A

----> #TABLA2_F
If OBJECT_ID('tempdb..#TABLA2_F') IS NOT NULL DROP TABLE #TABLA2_F

CREATE TABLE #TABLA2_F
([ROW] VARCHAR (5),CONTRATO VARCHAR(18), DETALLE VARCHAR(800))

INSERT INTO #TABLA2_F
SELECT ROW_NUMBER() OVER(PARTITION BY CONTRATO  ORDER BY FECfase ASC) AS Row ,CONTRATO,DETALLE
from #TABLA1_F


----> ##TABLA2_PIVOT
If OBJECT_ID('tempdb..#TABLA2_PIVOT') IS NOT NULL DROP TABLE #TABLA2_PIVOT

CREATE TABLE #TABLA2_PIVOT
(CONTRATO VARCHAR (18),
[1] VARCHAR (800),[2] VARCHAR (800),[3] VARCHAR (800),[4] VARCHAR (800),[5] VARCHAR (800),[6] VARCHAR (800),[7] VARCHAR (800),[8] VARCHAR (800),[9] VARCHAR (800),[10] VARCHAR (800),
[11] VARCHAR (800),[12] VARCHAR (800),[13] VARCHAR (800),[14] VARCHAR (800),[15] VARCHAR (800),[16] VARCHAR (800),[17] VARCHAR (800),[18] VARCHAR (800),[19] VARCHAR (800),[20] VARCHAR (800),
[21] VARCHAR (800),[22] VARCHAR (800),[23] VARCHAR (800),[24] VARCHAR (800),[25] VARCHAR (800),[26] VARCHAR (800),[27] VARCHAR (800),[28] VARCHAR (800),[29] VARCHAR (800),[30] VARCHAR (800),
[31] VARCHAR (800),[32] VARCHAR (800),[33] VARCHAR (800),[34] VARCHAR (800),[35] VARCHAR (800),[36] VARCHAR (800),[37] VARCHAR (800),[38] VARCHAR (800),[39] VARCHAR (800),[40] VARCHAR (800),
[41] VARCHAR (800),[42] VARCHAR (800),[43] VARCHAR (800),[44] VARCHAR (800),[45] VARCHAR (800),[46] VARCHAR (800),[47] VARCHAR (800),[48] VARCHAR (800),[49] VARCHAR (800),[50] VARCHAR (800),
[51] VARCHAR (800),[52] VARCHAR (800),[53] VARCHAR (800),[54] VARCHAR (800),[55] VARCHAR (800),[56] VARCHAR (800),[57] VARCHAR (800),[58] VARCHAR (800),[59] VARCHAR (800),[60] VARCHAR (800),
[61] VARCHAR (800),[62] VARCHAR (800),[63] VARCHAR (800),[64] VARCHAR (800),[65] VARCHAR (800),[66] VARCHAR (800),[67] VARCHAR (800),[68] VARCHAR (800),[69] VARCHAR (800),[70] VARCHAR (800),
[71] VARCHAR (800),[72] VARCHAR (800),[73] VARCHAR (800),[74] VARCHAR (800),[75] VARCHAR (800),[76] VARCHAR (800),[77] VARCHAR (800),[78] VARCHAR (800),[79] VARCHAR (800),[80] VARCHAR (800),
[81] VARCHAR (800),[82] VARCHAR (800),[83] VARCHAR (800),[84] VARCHAR (800),[85] VARCHAR (800),[86] VARCHAR (800),[87] VARCHAR (800),[88] VARCHAR (800),[89] VARCHAR (800),[90] VARCHAR (800),
[91] VARCHAR (800),[92] VARCHAR (800),[93] VARCHAR (800),[94] VARCHAR (800),[95] VARCHAR (800),[96] VARCHAR (800),[97] VARCHAR (800),[98] VARCHAR (800),[99] VARCHAR (800),[100] VARCHAR (800),
[101] VARCHAR (800),[102] VARCHAR (800),[103] VARCHAR (800),[104] VARCHAR (800),[105] VARCHAR (800),[106] VARCHAR (800),[107] VARCHAR (800),[108] VARCHAR (800),[109] VARCHAR (800),[110] VARCHAR (800),
[111] VARCHAR (800),[112] VARCHAR (800),[113] VARCHAR (800),[114] VARCHAR (800),[115] VARCHAR (800),[116] VARCHAR (800),[117] VARCHAR (800),[118] VARCHAR (800),[119] VARCHAR (800),[120] VARCHAR (800),
[121] VARCHAR (800),[122] VARCHAR (800),[123] VARCHAR (800),[124] VARCHAR (800),[125] VARCHAR (800),[126] VARCHAR (800),[127] VARCHAR (800),[128] VARCHAR (800),[129] VARCHAR (800),[130] VARCHAR (800),
[131] VARCHAR (800),[132] VARCHAR (800),[133] VARCHAR (800),[134] VARCHAR (800),[135] VARCHAR (800),[136] VARCHAR (800),[137] VARCHAR (800),[138] VARCHAR (800),[139] VARCHAR (800),[140] VARCHAR (800),
[141] VARCHAR (800),[142] VARCHAR (800),[143] VARCHAR (800),[144] VARCHAR (800),[145] VARCHAR (800),[146] VARCHAR (800),[147] VARCHAR (800),[148] VARCHAR (800),[149] VARCHAR (800),[150] VARCHAR (800),
[151] VARCHAR (800),[152] VARCHAR (800),[153] VARCHAR (800),[154] VARCHAR (800),[155] VARCHAR (800),[156] VARCHAR (800),[157] VARCHAR (800),[158] VARCHAR (800),[159] VARCHAR (800),[160] VARCHAR (800),
[161] VARCHAR (800),[162] VARCHAR (800),[163] VARCHAR (800),[164] VARCHAR (800),[165] VARCHAR (800),[166] VARCHAR (800),[167] VARCHAR (800),[168] VARCHAR (800),[169] VARCHAR (800),[170] VARCHAR (800),
[171] VARCHAR (800),[172] VARCHAR (800),[173] VARCHAR (800),[174] VARCHAR (800),[175] VARCHAR (800),[176] VARCHAR (800),[177] VARCHAR (800),[178] VARCHAR (800),[179] VARCHAR (800),[180] VARCHAR (800),
[181] VARCHAR (800),[182] VARCHAR (800),[183] VARCHAR (800),[184] VARCHAR (800),[185] VARCHAR (800),[186] VARCHAR (800),[187] VARCHAR (800),[188] VARCHAR (800),[189] VARCHAR (800),[190] VARCHAR (800),
[191] VARCHAR (800),[192] VARCHAR (800),[193] VARCHAR (800),[194] VARCHAR (800),[195] VARCHAR (800),[196] VARCHAR (800),[197] VARCHAR (800),[198] VARCHAR (800),[199] VARCHAR (800),[200] VARCHAR (800),
[201] VARCHAR (800),[202] VARCHAR (800),[203] VARCHAR (800),[204] VARCHAR (800),[205] VARCHAR (800),[206] VARCHAR (800),[207] VARCHAR (800),[208] VARCHAR (800),[209] VARCHAR (800),[210] VARCHAR (800),
[211] VARCHAR (800),[212] VARCHAR (800),[213] VARCHAR (800),[214] VARCHAR (800),[215] VARCHAR (800),[216] VARCHAR (800),[217] VARCHAR (800),[218] VARCHAR (800),[219] VARCHAR (800),[220] VARCHAR (800),
[221] VARCHAR (800),[222] VARCHAR (800),[223] VARCHAR (800),[224] VARCHAR (800),[225] VARCHAR (800),[226] VARCHAR (800),[227] VARCHAR (800),[228] VARCHAR (800),[229] VARCHAR (800),[230] VARCHAR (800),
[231] VARCHAR (800),[232] VARCHAR (800),[233] VARCHAR (800),[234] VARCHAR (800),[235] VARCHAR (800),[236] VARCHAR (800),[237] VARCHAR (800),[238] VARCHAR (800),[239] VARCHAR (800),[240] VARCHAR (800),
[241] VARCHAR (800),[242] VARCHAR (800),[243] VARCHAR (800),[244] VARCHAR (800),[245] VARCHAR (800),[246] VARCHAR (800),[247] VARCHAR (800),[248] VARCHAR (800),[249] VARCHAR (800),[250] VARCHAR (800),
[251] VARCHAR (800),[252] VARCHAR (800),[253] VARCHAR (800),[254] VARCHAR (800),[255] VARCHAR (800),[256] VARCHAR (800),[257] VARCHAR (800),[258] VARCHAR (800),[259] VARCHAR (800),[260] VARCHAR (800),
[261] VARCHAR (800),[262] VARCHAR (800),[263] VARCHAR (800),[264] VARCHAR (800),[265] VARCHAR (800),[266] VARCHAR (800),[267] VARCHAR (800),[268] VARCHAR (800),[269] VARCHAR (800),[270] VARCHAR (800),
[271] VARCHAR (800),[272] VARCHAR (800),[273] VARCHAR (800),[274] VARCHAR (800),[275] VARCHAR (800),[276] VARCHAR (800),[277] VARCHAR (800),[278] VARCHAR (800),[279] VARCHAR (800),[280] VARCHAR (800),
[281] VARCHAR (800),[282] VARCHAR (800),[283] VARCHAR (800),[284] VARCHAR (800),[285] VARCHAR (800),[286] VARCHAR (800),[287] VARCHAR (800),[288] VARCHAR (800),[289] VARCHAR (800),[290] VARCHAR (800),
[291] VARCHAR (800),[292] VARCHAR (800),[293] VARCHAR (800),[294] VARCHAR (800),[295] VARCHAR (800),[296] VARCHAR (800),[297] VARCHAR (800),[298] VARCHAR (800),[299] VARCHAR (800),[300] VARCHAR (800),
[301] VARCHAR (800),[302] VARCHAR (800),[303] VARCHAR (800),[304] VARCHAR (800),[305] VARCHAR (800),[306] VARCHAR (800),[307] VARCHAR (800),[308] VARCHAR (800),[309] VARCHAR (800),[310] VARCHAR (800))


insert into #TABLA2_PIVOT
select * FROM  #TABLA2_F
PIVOT (max(DETALLE) FOR ROW IN  (
[1],[2],[3],[4],[5],[6],[7],[8],[9],[10],
[11],[12],[13],[14],[15],[16],[17],[18],[19],[20],
[21],[22],[23],[24],[25],[26],[27],[28],[29],[30],
[31],[32],[33],[34],[35],[36],[37],[38],[39],[40],
[41],[42],[43],[44],[45],[46],[47],[48],[49],[50],
[51],[52],[53],[54],[55],[56],[57],[58],[59],[60],
[61],[62],[63],[64],[65],[66],[67],[68],[69],[70],
[71],[72],[73],[74],[75],[76],[77],[78],[79],[80],
[81],[82],[83],[84],[85],[86],[87],[88],[89],[90],
[91],[92],[93],[94],[95],[96],[97],[98],[99],[100]
,
[101],[102],[103],[104],[105],[106],[107],[108],[109],[110],
[111],[112],[113],[114],[115],[116],[117],[118],[119],[120],
[121],[122],[123],[124],[125],[126],[127],[128],[129],[130],
[131],[132],[133],[134],[135],[136],[137],[138],[139],[140],
[141],[142],[143],[144],[145],[146],[147],[148],[149],[150],
[151],[152],[153],[154],[155],[156],[157],[158],[159],[160],
[161],[162],[163],[164],[165],[166],[167],[168],[169],[170],
[171],[172],[173],[174],[175],[176],[177],[178],[179],[180],
[181],[182],[183],[184],[185],[186],[187],[188],[189],[190],
[191],[192],[193],[194],[195],[196],[197],[198],[199],[200],
[201],[202],[203],[204],[205],[206],[207],[208],[209],[210],
[211],[212],[213],[214],[215],[216],[217],[218],[219],[220],
[221],[222],[223],[224],[225],[226],[227],[228],[229],[230],
[231],[232],[233],[234],[235],[236],[237],[238],[239],[240],
[241],[242],[243],[244],[245],[246],[247],[248],[249],[250],
[251],[252],[253],[254],[255],[256],[257],[258],[259],[260],
[261],[262],[263],[264],[265],[266],[267],[268],[269],[270],
[271],[272],[273],[274],[275],[276],[277],[278],[279],[280],
[281],[282],[283],[284],[285],[286],[287],[288],[289],[290],
[291],[292],[293],[294],[295],[296],[297],[298],[299],[300],
[301],[302],[303],[304],[305],[306],[307],[308],[309],[310]
))AS unpvt
------------------------------------------------

If OBJECT_ID('tempdb..#TABLA2_PIVOT_FINAL') IS NOT NULL DROP TABLE #TABLA2_PIVOT_FINAL
CREATE TABLE #TABLA2_PIVOT_FINAL
(CONTRATO VARCHAR (18), OBSERVACION VARCHAR (8000))

INSERT INTO #TABLA2_PIVOT_FINAL
select distinct contrato, isnull([1],'')+' / '+isnull([2],'')+' / '+isnull([3],'')+' / '+isnull([4],'')+' / '+isnull([5],'')+' / '+isnull([6],'')+' / '+isnull([7],'')+' / '+isnull([8],'')+' / '+isnull([9],'')+' / '+isnull([10],'')+' / '+
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
from #TABLA2_PIVOT order by 1 desc

----------------------
----HISTORIA PROCESAL
----------------------
UPDATE A
SET A.HISTORIA_PROCESAL=B.OBSERVACION
FROM PD_DECRECIENTE_JUDICIAL   AS A,  #TABLA2_PIVOT_FINAL  AS B
WHERE A.CONTRATO=B.CONTRATO

----------------------
----MARCA LEASING
----------------------
UPDATE A
SET A.GRUPO_LEASING=CASE
WHEN (A.HIPOTECA='SI') OR (A.FLAG_GIA_FIADOR='SI') OR (A.PRENDA='SI') OR (A.LIQUIDAS='SI') THEN 'LEASING_SI_GTIAS'
ELSE 'LEASING_NO_GTIAS' END
FROM PD_DECRECIENTE_JUDICIAL  AS A
WHERE PRODUCTO='LEASING'

---------------------------------
--->  TASA DE COBERTURA
---------------------------------
UPDATE A
SET A.Cobertura=CASE
WHEN (B.GARANTIA/A.RIESGO_TOTAL) <1  THEN 'Menor a 100%'
WHEN (B.GARANTIA/A.RIESGO_TOTAL) >=1 THEN 'Mayor Igual a 100%'
else 'Sin Garantia Real' end
FROM PD_DECRECIENTE_JUDICIAL as a,  (select DISTINCT CODCENTRAL, (ISNULL(HIPOTECA,0) + ISNULL(LIQUIDAS,0)+ ISNULL(PRENDA,0)) AS GARANTIA
FROM GARANTIAS_MES) B
WHERE A.CODCENTRAL=B.CODCENTRAL
AND A.RIESGO_TOTAL>0


------------------------
--CAMPOS ADICIONALES
------------------------
---------------------------------
----"Vtas Propuestas".
--------------------------------
--UPDATE A
--SET A.VENTA_IRCSA=CASE WHEN B.CONTRATO IS NULL THEN 'NO' ELSE 'SI' END
--FROM PD_DECRECIENTE_JUDICIAL AS A
--LEFT JOIN RIE_MORA.DBO.MHV_VENTA_SETIEMBRE AS B
--ON A.CONTRATO=B.CONTRATO

UPDATE A
SET A.FLAG_DBTX=CASE WHEN B.CONTRATO IS NULL THEN 'NO' ELSE 'SI' END
FROM PD_DECRECIENTE_JUDICIAL AS A
LEFT JOIN TABLA_DBTX_4 AS B
ON A.CONTRATO=B.CONTRATO

----------------------------------
---> FLAG FIADOR PYME CON DEUDA BANCO
----------------------------------
UPDATE C
SET C.FLAG_FIADOR_DEUDA_BANCO='FIADOR CON DEUDA EN PERSONAS'
FROM PD_DECRECIENTE_JUDICIAL AS C,
(SELECT DISTINCT A.CODCENTRAL
FROM PD_DECRECIENTE_JUDICIAL AS A,
(SELECT distinct A.c_cent_clie, B.FIADOR
FROM GARANTIAS_DETALLE AS A LEFT JOIN #MHV_CRGA14 AS B
ON A.N_GARANTIA=B.GARANTIA
WHERE I_TIPO_GARA='311') B
WHERE A.Codcentral=B.FIADOR
AND A.Codcentral IN (SELECT DISTINCT c_cent_clie FROM GARANTIAS_DETALLE WHERE I_TIPO_GARA='311' )
AND [SEGMENTO DE NEGOCIO] IN ('PARTICULARES')) D
WHERE C.CODCENTRAL=D.CODCENTRAL
--AND [SEGMENTO DE NEGOCIO]='PYME'

-----------------------------------------------Añadido 12/03  FLAGS FONDOS DEL GOBIERNO, SUBPRODUCTO

If OBJECT_ID('tempdb..#TMP') IS NOT NULL DROP TABLE #TMP
SELECT  DISTINCT NUME_CONT_OPER,SUBPRODUCTO [SUBPROD]
INTO #TMP
FROM XCOM_RCDTRA_HOY
WHERE SUBSTRING(NUME_CONT_OPER,9,2)<>'50'
AND (CTA_CTBL LIKE ('14_6%') OR CTA_CTBL LIKE ('14_5%') OR CTA_CTBL LIKE ('14_4%') ---JUDICIAL,VENCIDO,REESTRUCTURADO
OR CTA_CTBL LIKE ('14_3%') OR CTA_CTBL LIKE ('14_1%')) ---REFINANCIADO,VIGENTE  (POS3: 1 SOL 2 USD)


If OBJECT_ID('tempdb..#TMP2') IS NOT NULL DROP TABLE #TMP2
SELECT DISTINCT NUME_CONT_OPER,SUBPRODUCTO [SUBPROD]
INTO #TMP2
FROM XCOM_RCDTRA_HOY
WHERE SUBSTRING(NUME_CONT_OPER,9,2)='50'
AND (CTA_CTBL LIKE ('14_6%') OR CTA_CTBL LIKE ('14_5%') OR CTA_CTBL LIKE ('14_4%') ---JUDICIAL,VENCIDO,REESTRUCTURADO
OR CTA_CTBL LIKE ('14_3%') OR CTA_CTBL LIKE ('14_1%')) ---REFINANCIADO,VIGENTE  (POS3: 1 SOL 2 USD)


If OBJECT_ID('tempdb..#TMP3') IS NOT NULL DROP TABLE #TMP3
SELECT *,case when  [SUBPROD] in ('VSM1','VSM2','VSM3','VSM4','VSM6','NS3B','VSR1','VSR2','VSR3') then 1 ELSE 0 END Flag_Fondo_Reactiva
,case WHEN  [SUBPROD] in ('NS1B','ND1B','NS2B','ND2B') then 1 ELSE 0 END Flag_Fondo_Crecer
--,case WHEN  [SUBPROD] in ('ADF1','ADF2','ASF1','ASF2','ASF5','ASF6','ADF5','ADF6') then 1 ELSE 0 END Flag_Consumer
,case WHEN  [SUBPROD] like 'ADF%'  OR [SUBPROD] like 'ASF%' then 1 ELSE 0 END Flag_Consumer
,case WHEN  [SUBPROD] in ('MS14') then 1 ELSE 0 END Flag_Convenio
,0 Flag_FAE
INTO #TMP3
FROM #TMP
UNION
SELECT *,0 Flag_Fondo_Reactiva,0 Flag_Fondo_Crecer,0 Flag_Consumer,0 Flag_Convenio,0 Flag_FAE FROM #TMP2

If OBJECT_ID('tempdb..#TMP3_') IS NOT NULL DROP TABLE #TMP3_
select distinct NUME_CONT_OPER,subprod,Flag_Fondo_Reactiva, Flag_Fondo_Crecer, Flag_Consumer,Flag_Convenio, Flag_FAE into #TMP3_ from #TMP3

DELETE FROM #TMP3_ WHERE NUME_CONT_OPER='001102529600085350' AND Flag_Consumer=0

--select NUME_CONT_OPER,count(*) from #TMP3_  group by NUME_CONT_OPER having count(*)>1



--Flag FAE

If OBJECT_ID('tempdb..#TMP_FAE') IS NOT NULL DROP TABLE #TMP_FAE
SELECT [Número Préstamo] , 1 Flag_FAE  INTO #TMP_FAE FROM BASE_FAE_COVID19 WHERE CANCELADO = 0


UPDATE A
SET A.Flag_FAE=b.Flag_FAE
FROM #TMP3_ AS A
INNER JOIN #TMP_FAE AS B ON A.NUME_CONT_OPER=B.[Número Préstamo]


UPDATE A
SET A.Flag_Fondo_Reactiva=B.Flag_Fondo_Reactiva,
A.Flag_Fondo_Crecer=B.Flag_Fondo_Crecer,
A.Flag_Consumer=B.Flag_Consumer,
A.Flag_Convenio=B.Flag_Convenio,
A.Flag_FAE=B.Flag_FAE,
A.SUBPROD=B.SUBPROD
FROM PD_DECRECIENTE_JUDICIAL AS A
LEFT JOIN #TMP3_ AS B
ON A.CONTRATO=B.NUME_CONT_OPER

-------------Nuevo 12/01/2022
If OBJECT_ID('tempdb..#suproducto') IS NOT NULL DROP TABLE #suproducto
select codsubproducto,IsNull(descripcion,'') AS SubProducto INTO #suproducto from EX.CobranzaCM.dbo.subProducto

UPDATE A
SET A.SubProducto=B.SubProducto
FROM PD_DECRECIENTE_JUDICIAL AS A
LEFT JOIN #suproducto AS B
ON A.SUBPROD=B.codsubproducto and a.SUBPROD<>''
-------------------------------------------------------


---------Nuevo 06/12
UPDATE A
SET A.FondoDeGobierno=B.FondoDeGobierno
FROM PD_DECRECIENTE_JUDICIAL AS A
LEFT JOIN [dbo].[Mora_Honramientos] AS B
ON A.CONTRATO=B.contrato

----------------AÑADIDO 25/01/2022

If OBJECT_ID('tempdb..#COMPARATIVOSALDOS') IS NOT NULL DROP TABLE #COMPARATIVOSALDOS
SELECT A.CONTRATO,A.JUD,ROUND(B.SALDO_SOL,2) SALDO_SOL
INTO #COMPARATIVOSALDOS
FROM PD_UNIVERSO_DIARIO A
LEFT JOIN #ContratoBC_TotalSolarizado_Total B
ON A.CONTRATO=B.CONTRATO
WHERE A.JUD>0

If OBJECT_ID('tempdb..#COMPARATIVOSALDOS2') IS NOT NULL DROP TABLE #COMPARATIVOSALDOS2
SELECT *,ROUND(JUD-SALDO_SOL,0) DIF INTO #COMPARATIVOSALDOS2 FROM #COMPARATIVOSALDOS WHERE JUD<>SALDO_SOL

If OBJECT_ID('tempdb..#honrados') IS NOT NULL DROP TABLE #honrados
SELECT CONTRATO into #honrados FROM #COMPARATIVOSALDOS2 WHERE DIF<>0 and CONTRATO  in (select NUME_CONT_OPER from #TMP3_ where flag_fondo_reactiva=1)

update Mora_Honramientos set FondoDeGobierno='Honrado' where contrato in (select contrato from #honrados)

insert into Mora_Honramientos
select contrato,'Honrado','20220124' from #honrados where contrato not in (select contrato from Mora_Honramientos where FondoDeGobierno='Honrado')
--------------


----------------------
----VALIDACION
----------------------
SELECT DISTINCT SEGMENTACION, GESTOR, COUNT(*)CONTRATOS
FROM PD_DECRECIENTE_JUDICIAL
WHERE  [SEGMENTO DE NEGOCIO]  NOT IN ('EMPRESAS')   AND [SEGMENTO DE NEGOCIO] IN ('PARTICULARES','PYME')
AND [SALDO JUDICIAL]>0
GROUP BY SEGMENTACION, GESTOR


DELETE FROM PD_DECRECIENTE_JUDICIAL_GESTION
INSERT INTO PD_DECRECIENTE_JUDICIAL_GESTION
SELECT FECHA, CODCENTRAL, CONTRATO, DNI, RUC, CLIENTE, PRODUCTO_FINAL, CLASIF_BANCO =CASE WHEN CLASIFICACION IN ('0')  THEN 'NORMAL'
WHEN CLASIFICACION IN ('1')  THEN 'CPP' WHEN CLASIFICACION IN ('2')  THEN 'DEFICIENTE' WHEN CLASIFICACION IN ('3')  THEN 'DUDOSO' WHEN CLASIFICACION IN ('4')  THEN 'PERDIDA'
ELSE '' END ,DA AS DIASVENCIMIENTO, [SALDO VIGENTE],  [SALDO REFINANCIADO] ,[SALDO VENCIDO], [SALDO JUDICIAL],[ESTUDIO ASIGNADO] , [ESTUDIO ASIGNADO WR51] , [SEGMENTO DE NEGOCIO] ,[SEGMENTACION] AS SEGMENTACION_INTERNA, [GESTOR],  CODOFIC, OFICINA
,TERRITORIO,LIMA_PROV,RANGO_DEUDA, RIESGO_TOTAL, PROVISIONES,  UGA, FECHA_INGRESO_MORA, TIEMPO_EN_JUDICIAL, FECHA_ASIGNACION,FLAG_GIA_REAL AS CLIENTE_CON_GARANTIA, FLAG_GIA_FIADOR AS FIADOR_CON_GARANTIA, FLAG_FIANZA AS FIANZA, LIQUIDAS, PRENDA
,HIPOTECA, FLAG_MIVIVIENDA AS MIVIVIENDA,FLAG_GESTION_AGENCIAS AS EN_GESTION_AGENCIAS, COBERTURA AS COBERTURA_GARANTIAS, EMBARGO AS [POSEE EMBARGO],TIPO_LEASING,
(ISNULL(PROCESO_N1,'') + ' / ' + ISNULL(PROCESO_N2,'')+ ' / '+ ISNULL(PROCESO_N3,'')+ ' / '+ ISNULL(PROCESO_N4,'')+ ' / '+ ISNULL(PROCESO_N5,'')+ ' / '+ ISNULL(PROCESO_N6,'')+ ' / '+ ISNULL(PROCESO_N7,''))  AS PROCESO_JUDICIAL_SAE,
(ISNULL(GARANTIA_1,'') + ' / ' +ISNULL(GARANTIA_2,'') + ' / ' +ISNULL(GARANTIA_3,'') + ' / ' +ISNULL(GARANTIA_4,'') + ' / ' +ISNULL(GARANTIA_5,'') + ' / ' +ISNULL(GARANTIA_6,'') + ' / ' +ISNULL(GARANTIA_7,'') + ' / '
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
#ERROR!
NULL , NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL,NULL,GRUPO, NULL,NULL,NULL,NULL,NULL,SUBPROD,Flag_Fondo_Reactiva,Flag_Fondo_Crecer, Flag_FAE,Flag_Consumer,Flag_Convenio,sigla,VAL_REAL_HIPOTECA,VAL_REAL_PRENDA,FondoDeGobierno,SubProducto,NULL


FROM PD_DECRECIENTE_JUDICIAL
WHERE [SALDO JUDICIAL]>0
ORDER BY CODCENTRAL ASC



-------------------------------------------------------------------------------------------

---------------------------------------------------------------------------------------------------------------------------------------------------------------------
---GENERACIÓN DE TABLA DE SEGUIMIENTO DAIRIO DE LA GESTIÓN DE OPPLUS
---PREVIAMENTE DEBE ACTUALIZARSE LAS TABLAS DATA_OPPLUS
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
--CREATE TABLE #TABLA_DOCUMENTOS
--(CONTRATO VARCHAR (18),NOM_PRO NVARCHAR(100), TIPO_LEGAJO VARCHAR(40) )

-----> AQUI ME QUEDE AUTOMATIZANDO
--INSERT INTO #TABLA_DOCUMENTOS
--SELECT SUBSTRING(COLUMN1,2,18) AS CONTRATO , NOM_PRO, null FROM DATA_OPPLUS

-------------------------
-----DOCUMENTO COMPLETO--
-------------------------
--UPDATE  A
--SET A.TIPO_LEGAJO='DOCUMENTO COMPLETO'  ----> SOLICITAR A OPPLUS QUE ACTUALICEN LA BASE DE FALTANTES DE ATENCIÓN DE IRON MOUNTAIN
--FROM #TABLA_DOCUMENTOS AS A, (SELECT DISTINCT SUBSTRING(COLUMN1,2,18) AS CONTRATO  FROM DATA_OPPLUS
--WHERE CC2='COMPLETO') B
--WHERE A.CONTRATO=B.CONTRATO

-------------------------
-----DOCUMENTO MINIMOS--
-------------------------
--UPDATE  A
--SET A.TIPO_LEGAJO='DOCUMENTOS MINIMOS'  ----> SOLICITAR A OPPLUS QUE ACTUALICEN LA BASE DE FALTANTES DE ATENCIÓN DE IRON MOUNTAIN
--FROM #TABLA_DOCUMENTOS AS A, (SELECT DISTINCT SUBSTRING(COLUMN1,2,18) AS CONTRATO  FROM DATA_OPPLUS
--    WHERE CC2='DOCUMENTOS MINIMOS') B
--WHERE A.CONTRATO=B.CONTRATO
--AND A.TIPO_LEGAJO IS NULL
-------------------------------------------------------------------------------
-----GENERACION DEL MINIMO EXIGIBLE
-------------------------------------------------------------------------------
---------------------------
-----PRÉSTAMOS CONSUMO
--------------------------
--UPDATE  A
--SET A.TIPO_LEGAJO='MINIMOS EXIGIBLES'
--FROM #TABLA_DOCUMENTOS AS A
--WHERE A.CONTRATO IN (SELECT SUBSTRING(COLUMN1,2,18) AS CONTRATO FROM DATA_OPPLUS
--     WHERE NOM_PRO IN ('PRÉSTAMOS CONSUMO')  AND NOM_DOC in ('CONTRATO') AND NOM_EST IN ('DOCUMENTO RECIBIDO'))
--AND A.CONTRATO IN (SELECT SUBSTRING(COLUMN1,2,18) AS CONTRATO FROM DATA_OPPLUS
--     WHERE NOM_PRO IN ('PRÉSTAMOS CONSUMO')  AND NOM_DOC in ('PAGARÉ') AND NOM_EST IN ('DOCUMENTO RECIBIDO'))
--AND A.NOM_PRO='PRÉSTAMOS CONSUMO'
--AND A.TIPO_LEGAJO IS NULL

---------------------------    -----PRÉSTAMO VEHICULAR
--------------------------
--UPDATE  A
--SET A.TIPO_LEGAJO='MINIMOS EXIGIBLES'
--FROM #TABLA_DOCUMENTOS AS A
--WHERE A.CONTRATO IN (SELECT SUBSTRING(COLUMN1,2,18) AS CONTRATO FROM DATA_OPPLUS
--     WHERE NOM_PRO IN ('PRÉSTAMO VEHICULAR') AND NOM_DOC in ('PRENDA VEHICULAR/GARANTÍA MOBILIARIA') AND NOM_EST IN ('DOCUMENTO RECIBIDO'))
--AND A.NOM_PRO='PRÉSTAMO VEHICULAR'
--AND A.TIPO_LEGAJO IS NULL

---------------------------
-----HIPOTECARIO
--------------------------
--UPDATE  A
--SET A.TIPO_LEGAJO='MINIMOS EXIGIBLES'
--FROM #TABLA_DOCUMENTOS AS A
--WHERE A.CONTRATO IN (SELECT SUBSTRING(COLUMN1,2,18) AS CONTRATO FROM DATA_OPPLUS
--     WHERE NOM_PRO IN ('HIPOTECARIO') AND NOM_DOC in ('TESTIMONIO') AND NOM_EST IN ('DOCUMENTO RECIBIDO'))

--AND A.NOM_PRO='HIPOTECARIO'
--AND A.TIPO_LEGAJO IS NULL

------------------------------------------------------------------------------------
-----CRED. INMOBILIARIOS','PRÉSTAMOS COMERCIALES','PRÉSTAMOS PYMES
-----------------------------------------------------------------------------------
--UPDATE  A
--SET A.TIPO_LEGAJO='MINIMOS EXIGIBLES'
--FROM #TABLA_DOCUMENTOS AS A
--WHERE A.CONTRATO IN (SELECT SUBSTRING(COLUMN1,2,18) AS CONTRATO FROM DATA_OPPLUS
--     WHERE NOM_PRO IN ('CRED. INMOBILIARIOS','PRÉSTAMOS COMERCIALES','PRÉSTAMOS PYMES')
--     AND NOM_DOC in ('CONTRATO') AND NOM_EST IN ('DOCUMENTO RECIBIDO'))

--AND A.CONTRATO IN (SELECT SUBSTRING(COLUMN1,2,18) AS CONTRATO FROM DATA_OPPLUS
--     WHERE NOM_PRO IN ('CRED. INMOBILIARIOS','PRÉSTAMOS COMERCIALES','PRÉSTAMOS PYMES')
--     AND NOM_DOC in ('PAGARÉ') AND NOM_EST IN ('DOCUMENTO RECIBIDO'))

--AND A.CONTRATO IN (SELECT SUBSTRING(COLUMN1,2,18) AS CONTRATO FROM DATA_OPPLUS
--     WHERE NOM_PRO IN ('CRED. INMOBILIARIOS','PRÉSTAMOS COMERCIALES','PRÉSTAMOS PYMES')
--     AND NOM_DOC in ('CRONOGRAMA FIRMADO') AND NOM_EST IN ('DOCUMENTO RECIBIDO'))
--AND A.NOM_PRO IN ('CRED. INMOBILIARIOS','PRÉSTAMOS COMERCIALES','PRÉSTAMOS PYMES')
--AND A.TIPO_LEGAJO IS NULL

------------------------------------------------------------------------------------
-----TARJETA CONSUMO
-----------------------------------------------------------------------------------
--UPDATE  A
--SET A.TIPO_LEGAJO='MINIMOS EXIGIBLES'
--FROM #TABLA_DOCUMENTOS AS A
--WHERE A.CONTRATO IN (SELECT SUBSTRING(COLUMN1,2,18) AS CONTRATO FROM DATA_OPPLUS
--     WHERE NOM_PRO IN ('TARJETA CONSUMO')
--     AND NOM_DOC in ('CONTRATO') AND NOM_EST IN ('DOCUMENTO RECIBIDO'))
--AND A.NOM_PRO IN ('TARJETA CONSUMO')
--AND A.TIPO_LEGAJO IS NULL

------------------------------------------------------------------------------------
-----TARJETA COMERCIALES
-----------------------------------------------------------------------------------
--UPDATE  A
--SET A.TIPO_LEGAJO='MINIMOS EXIGIBLES'
--FROM #TABLA_DOCUMENTOS AS A
--WHERE A.CONTRATO IN (SELECT SUBSTRING(COLUMN1,2,18) AS CONTRATO FROM DATA_OPPLUS
--     WHERE NOM_PRO IN ('TARJETA COMERCIALES')
--     AND NOM_DOC in ('CONTRATO') AND NOM_EST IN ('DOCUMENTO RECIBIDO'))
--AND A.NOM_PRO IN ('TARJETA COMERCIALES')
--AND A.TIPO_LEGAJO IS NULL

------------------------------------------------------------------------------------
-----TARJETA PYMES
-----------------------------------------------------------------------------------
--UPDATE  A
--SET A.TIPO_LEGAJO='MINIMOS EXIGIBLES'
--FROM #TABLA_DOCUMENTOS AS A
--WHERE A.CONTRATO IN (SELECT SUBSTRING(COLUMN1,2,18) AS CONTRATO FROM DATA_OPPLUS
--     WHERE NOM_PRO IN ('TARJETAS PYMES')
--     AND NOM_DOC in ('CONTRATO') AND NOM_EST IN ('DOCUMENTO RECIBIDO'))

--AND A.CONTRATO IN (SELECT SUBSTRING(COLUMN1,2,18) AS CONTRATO FROM DATA_OPPLUS
--     WHERE NOM_PRO IN ('TARJETAS PYMES')
--     AND NOM_DOC in ('PAGARÉ') AND NOM_EST IN ('DOCUMENTO RECIBIDO'))
--AND A.NOM_PRO IN ('TARJETAS PYMES')
--AND A.TIPO_LEGAJO IS NULL
-------------------------
-----INCOMPLETO
-------------------------
--UPDATE  A
--SET A.TIPO_LEGAJO='INCOMPLETO'
--FROM #TABLA_DOCUMENTOS AS A, (SELECT DISTINCT SUBSTRING(COLUMN1,2,18) AS CONTRATO  FROM DATA_OPPLUS
--    WHERE CC2='INCOMPLETO') B
--WHERE A.CONTRATO=B.CONTRATO
--AND A.TIPO_LEGAJO IS NULL

-------------------------
-----NO UBICADO EN IM
-------------------------
--UPDATE  A
--SET A.TIPO_LEGAJO='NO UBICADO EN IM'  ----> SOLICITAR A OPPLUS QUE ACTUALICEN LA BASE DE FALTANTES DE ATENCIÓN DE IRON MOUNTAIN
--FROM #TABLA_DOCUMENTOS AS A,RIE_MORA.DBO.MHV_IRON_FALTANTES AS B
--WHERE A.CONTRATO=B.CONTRATO
--AND A.TIPO_LEGAJO IS NULL
-----2563
-------------------------------------------------------------------------------
-----POR GESTIONAR: QUE LLEGÓ LA DOCUMENTACIÓN DE IRON PERO AÚN NO SE REVISA
-------------------------------------------------------------------------------
--UPDATE  A
--SET A.TIPO_LEGAJO='POR GESTIONAR'
--FROM #TABLA_DOCUMENTOS AS A, (SELECT DISTINCT SUBSTRING(COLUMN1,2,18) AS CONTRATO  FROM DATA_OPPLUS
--    WHERE CC2='POR GESTIONAR') B
--WHERE A.CONTRATO=B.CONTRATO
--AND A.TIPO_LEGAJO IS NULL

-----------------------------
----A.flag_asigna='SI'
-----------------------------
UPDATE A
SET A.flag_asigna='SI'
FROM PD_DECRECIENTE_JUDICIAL_GESTION  AS A
WHERE [ESTUDIO ASIGNADO] IS NOT NULL

-----------------------------
----SITUACION_LEGAJO
-----------------------------
--UPDATE A
--SET A.SITUACION_LEGAJO=B.TIPO_LEGAJO
--FROM PD_DECRECIENTE_JUDICIAL_GESTION  AS A , #TABLA_DOCUMENTOS  AS B
--WHERE A.CONTRATO=B.CONTRATO

---------------------
--OPPLUS='SI'
---------------------
--UPDATE A
--SET A.OPPLUS='SI'
--FROM PD_DECRECIENTE_JUDICIAL_GESTION  AS A , #TABLA_DOCUMENTOS AS B
--WHERE A.CONTRATO=B.CONTRATO

UPDATE A
SET A.OPPLUS=CASE WHEN B.CONTRATO IS NULL THEN 'NO' ELSE 'SI' END
FROM PD_DECRECIENTE_JUDICIAL_GESTION  AS A
LEFT JOIN PD_STOCK_LEGAJOS AS B ---RECIEN ASGINADOS
ON A.CONTRATO=B.CONTRATO
WHERE A.OPPLUS IS NULL

UPDATE A
SET A.OPPLUS='NO IDENTIFICADO'
FROM  PD_DECRECIENTE_JUDICIAL_GESTION AS A
WHERE [SALDO JUDICIAL]>0 AND [SEGMENTO DE NEGOCIO] IN ('PARTICULARES','PYME')
AND flag_asigna IS NULL
AND SUBSTRING(CONTRATO,9,2) IN ('50','96') AND OPPLUS='NO'


-------------------------
--- LEGAJO PREVENTIVO
----------------------------
UPDATE  A
SET A.TIPO_LEGAJO=B.TIPO_LEGAJO
FROM PD_DECRECIENTE_JUDICIAL  AS A, PD_STOCK_LEGAJOS AS B
WHERE A.CONTRATO=B.CONTRATO

UPDATE A
SET A.TIPO_STOCK='JUDICIAL'
FROM PD_DECRECIENTE_JUDICIAL  AS A
WHERE [SALDO JUDICIAL]>0
AND A.TIPO_LEGAJO IS NOT NULL


UPDATE A
SET A.TIPO_STOCK='PREVENTIVO'
FROM PD_DECRECIENTE_JUDICIAL  AS A
WHERE [SALDO JUDICIAL]=0
AND A.TIPO_LEGAJO IS NOT NULL



drop table #PROCESOS
drop table #FASES
drop table #JUDICIAL
drop table #tabla
drop table #tabla1
drop table #tabla2
drop table #TABLA1_F
drop table #TABLA2_F
drop table #TABLA2_PIVOT
drop table #TABLA2_PIVOT_FINAL
--drop table #TABLA_DOCUMENTOS



UPDATE A
SET A.MARCA_CHALLENGER='SI' --B.PUTBACK
FROM PD_DECRECIENTE_JUDICIAL_GESTION AS A JOIN PD_DBTX_DEVUELTOS AS B
ON A.CONTRATO=B.CONTRATO



-----------------------------------------------------------------------------------------------------------
/******************************REVISEMOS ESTA PARTE RENATA**********************************************/
/*****Modificado 20/08/20 - Preguntar a Carmen por qué ****/
/*****Modificado 01/09/20 - Se añadio a la lógica la casuística hipotecarios no garantizados ****/


If OBJECT_ID('tempdb..#tmp_situacion') IS NOT NULL DROP TABLE #tmp_situacion
SELECT a.contrato,a.resultado, a.codusuario,a.fecha, ROW_NUMBER() OVER(PARTITION BY A.CONTRATO ORDER BY A.FECHA DESC) AS ORDEN
into #tmp_situacion
from EX.CobranzaCM.dbo.TMP_Gestion_situacion_judicial a

delete from #tmp_situacion where orden>1


UPDATE A
SET A.TIPO_CARTERA=CASE WHEN A.SEGMENTACION_INTERNA LIKE '%PYME%' AND B.RESULTADO in ('3','7','9') THEN 'UNSECURED'
WHEN A.SEGMENTACION_INTERNA LIKE '%PYME%' AND B.RESULTADO in ('1','2','5','6','8','10','11','12') THEN 'SECURED'
WHEN A.SEGMENTACION_INTERNA LIKE '%MASIVOS%' AND B.RESULTADO in ('1','2','5','6','8','10','11','12') THEN 'SECURED'
WHEN A.SEGMENTACION_INTERNA LIKE '%MASIVOS%' AND B.RESULTADO in ('3','7','9') THEN 'UNSECURED'
WHEN A.SEGMENTACION_INTERNA LIKE '%EMPR%' AND B.RESULTADO in ('3','7','9') THEN 'UNSECURED'
WHEN A.SEGMENTACION_INTERNA LIKE '%EMPR%' AND B.RESULTADO in ('1','2','5','6','8','10','11','12') THEN 'SECURED'
WHEN A.SEGMENTACION_INTERNA LIKE '%VEHICULAR%' AND B.RESULTADO in ('3','7','9') THEN 'UNSECURED'
WHEN A.SEGMENTACION_INTERNA LIKE '%VEHICULAR%' AND B.RESULTADO in ('1','2','5','6','8','10','11','12') THEN 'SECURED'
WHEN A.SEGMENTACION_INTERNA LIKE '%HIPOTECARIO%' AND B.RESULTADO in ('3','7','9') THEN 'UNSECURED'
WHEN A.SEGMENTACION_INTERNA LIKE '%HIPOTECARIO%' AND B.RESULTADO in ('1','2','5','6','8','10','11','12') THEN 'SECURED'
ELSE TIPO_CARTERA END
FROM PD_DECRECIENTE_JUDICIAL_GESTION A
LEFT JOIN #tmp_situacion B
ON A.CONTRATO = B.CONTRATO collate Modern_Spanish_CI_AS

--Cambio Carmen Quispe Tabla Nueva Estructura  (CAMBIO!)
UPDATE A
SET A.GESTOR=CASE WHEN A.[SEGMENTO DE NEGOCIO] IN ('BEC','CIB') THEN B.GESTOR2--A.SEGMENTACION_INTERNA LIKE '%EMPRE%' THEN B.GESTOR2
ELSE B.GESTOR1 END
FROM PD_DECRECIENTE_JUDICIAL_GESTION A
INNER JOIN PD_TERRITORIO_GESTOR B  --PD_TERRITORIO_GESTOR
ON A.TIPO_CARTERA=B.CARTERA AND A.TERRITORIO=B.TERRITORIO


-----------------------------------------------------------------------------------------------
UPDATE A
SET
--   A.GARANTIA_EMBARGO = B.garantia_embargo,
--   A.ESTADO_PROCESAL = B.estado_procesal,
--A.OBSERVACIONES = B.observaciones,
A.SITUACION = B.resultado
FROM PD_DECRECIENTE_JUDICIAL_GESTION AS A
INNER JOIN #tmp_situacion AS B
ON A.CONTRATO = B.contrato collate Modern_Spanish_CI_AS

UPDATE A
SET A.SITUACION = CASE
WHEN A.SITUACION=1 THEN 'Embargo Total'
WHEN A.SITUACION=2 THEN 'Embargo Parcial'
WHEN A.SITUACION=3 THEN 'Embargo Irrealizable'
WHEN A.SITUACION=4 THEN 'En gestión'
WHEN A.SITUACION=5 THEN 'Garantizado Total'
WHEN A.SITUACION=6 THEN 'Garantizado Parcial'
WHEN A.SITUACION=7 THEN 'Garantías Prendarias'
WHEN A.SITUACION=8 THEN 'Garantías Irrealizables'
WHEN A.SITUACION=9 THEN 'No Garantizado'
WHEN A.SITUACION=10 THEN 'Leasing'
WHEN A.SITUACION=11 THEN 'INDECOPI'
WHEN A.SITUACION=12 THEN 'RFA/PREDA'
WHEN A.SITUACION=13 THEN 'Riesgo Reputacional'
WHEN A.SITUACION=14 THEN 'Saldo Insoluto'
WHEN A.SITUACION=15 THEN 'Sin Documentos'
END
FROM PD_DECRECIENTE_JUDICIAL_GESTION AS A

-------nuevo 11/06
--alter table PD_DECRECIENTE_JUDICIAL_GESTION add MARCA_DEPENDIENTE nvarchar(15)

----MARCA DEPENDIENTE/INDEPENDIENTE------------------------------------------------------------------------------
--If OBJECT_ID('tempdb..#MarcaDependiente') IS NOT NULL DROP TABLE #MarcaDependiente
--select TIP_DOC,documento,
--CASE WHEN CAT_PERSONA_R3_NEW IN ('1.1 Dependiente - PNN','1.Dependiente') THEN 'DEPENDIENTE'
--     WHEN CAT_PERSONA_R3_NEW IN ('2. Independiente Formal','3. Independiente PNN','4. PNN Informal','5. Independiente Informal') THEN 'INDEPENDIENTE'
--     WHEN CAT_PERSONA_R3_NEW = '6. No reconocido' THEN 'NO RECONOCIDO' END MARCA_DEPENDIENTE
--into #MarcaDependiente
--from mlnew2.bor.dbo.bp_tablon_mes


--If OBJECT_ID('tempdb..#tipodocumento') IS NOT NULL DROP TABLE #tipodocumento
--select distinct a.codcentral,b.tipdoc,b.numdoc
--into #tipodocumento
--from PD_DECRECIENTE_JUDICIAL_GESTION a
--inner join maeclien b
--on a.codcentral=b.codcent


--If OBJECT_ID('tempdb..#tipodocumento2') IS NOT NULL DROP TABLE #tipodocumento2
--select a.codcentral,b.MARCA_DEPENDIENTE
--into #tipodocumento2
--from #tipodocumento  A
--LEFT JOIN #MarcaDependiente B
--ON A.TIPDOC = B.TIP_DOC collate Modern_Spanish_CI_AS
--AND A.NUMDOC = B.documento collate Modern_Spanish_CI_AS


--UPDATE A
--SET
--A.MARCA_DEPENDIENTE=b.MARCA_DEPENDIENTE
--FROM PD_DECRECIENTE_JUDICIAL_GESTION A
--inner join #tipodocumento2 B
--on A.CODCENTRAL=B.CODCENTRAL
---------------------------------------------------------------


--If OBJECT_ID('tempdb..#FECHAMAXIMA') IS NOT NULL DROP TABLE #FECHAMAXIMA
--select MAX(FECHA_M)AS FECHAMAX INTO #FECHAMAXIMA
--from XCOM_ASIGNACION_ESTUDIOS_HOY

--UPDATE A
--SET
--A.COD_ESTUDIO_ANTERIOR=A.COD_ESTUDIO,
--A.USUARIO_ANTERIOR=A.USUARIO,
--A.FECHA_MODIFICA_ANTERIOR=A.FECHA_MODIFICA,
--A.COD_ESTUDIO=B.CODDATO,
--A.USUARIO=B.USUAR_M,
--A.FECHA_MODIFICA=B.FECHA_M,
--A.NOMBRE_ESTUDIO=C.nomb_estu
--FROM DISTRIBUCION_ESTUDIO A inner join XCOM_ASIGNACION_ESTUDIOS_HOY B
--on A.CONTRATO=B.CONTRATO
--INNER JOIN PD_CATALOGO_ESTUDIOS C
--ON B.CODDATO=C.sigla
--WHERE B.TIPODATO='0005' and (substring(USUAR_M,1,1)='P' OR substring(USUAR_M,1,1)='A') AND
--B.FECHA_M=(SELECT FECHAMAX FROM #FECHAMAXIMA)


/**********************************************************************************************/
/************************** ACTUALIZA SITUACION  ******************************/
/**********************************************************************************************/

UPDATE A
set
a.SITUACION_ANTERIOR=a.SITUACION
,a.FECHA_CAMBIO_SITUACION=b.FECHA
,a.SITUACION=b.SITUACION
FROM DISTRIBUCION_ESTUDIO A
INNER JOIN PD_UNIVERSO_DIARIO B
ON A.contrato=B.CONTRATO AND a.SITUACION<>b.SITUACION

UPDATE A
set
a.tipo_cartera_anterior=a.TIPO_CARTERA
,a.cartera_anterior=A.CARTERA
,a.GESTOR_ANTERIOR=A.GESTOR
,a.tipo_cartera=B.SEGMENTACION_INTERNA
,a.cartera=B.TIPO_CARTERA
,a.GESTOR=B.GESTOR
FROM DISTRIBUCION_ESTUDIO A
INNER JOIN PD_DECRECIENTE_JUDICIAL_GESTION B
ON A.contrato=B.CONTRATO AND a.CARTERA<>b.TIPO_CARTERA


If OBJECT_ID('CentroCobranzas.dbo.PD_DECRECIENTE_INFO_ADICIONAL') IS NOT NULL DROP TABLE CentroCobranzas.dbo.PD_DECRECIENTE_INFO_ADICIONAL
select CONTRATO,GESTOR,FLAG_GIA_REAl,FLAG_GIA_FIADOR,TERRITORIO,PRODUCTO
into PD_DECRECIENTE_INFO_ADICIONAL
from PD_DECRECIENTE_JUDICIAL

------------------Parche Fondo FAE 07/10/2021 Carmen Quispe

If OBJECT_ID('tempdb..#FondoFAE') IS NOT NULL DROP TABLE #FondoFAE
SELECT [Número Préstamo] CONTRATO, 'FAE' FONDO INTO #FondoFAE FROM BASE_FAE_COVID19 WHERE CANCELADO = 0

If OBJECT_ID('tempdb..#FondoFAE2') IS NOT NULL DROP TABLE #FondoFAE2
select substring(contrato,1,8)+substring(contrato,11,10) contrato,moneda,saldo
into #FondoFAE2 from PD_DECRECIENTE_DIARIO
where substring(ctacble,1,4) ='8412' and substring(contrato,1,8)+substring(contrato,11,10) in (select contrato from #FondoFAE)

If OBJECT_ID('tempdb..#FondoFAE3') IS NOT NULL DROP TABLE #FondoFAE3
DECLARE @Tipo_de_Cambio_FAE float
select @Tipo_de_Cambio_FAE =(select top 1 TC_COMPR from XCOM_TCCOB where TIP_CAMB = 'S' and DIVISA = 'USD' and FEC_CAMB=(select max(FEC_CAMB) from XCOM_TCCOB where TIP_CAMB = 'S' and DIVISA = 'USD')  order by FEC_CAMB desc)  --------CAMBIAR
select *, case when moneda='USD' then saldo*@Tipo_de_Cambio_FAE else saldo end saldo_sol into #FondoFAE3 from #FondoFAE2


UPDATE A
SET    A.[saldo judicial]=A.[saldo judicial]+b.saldo_sol
--select *
FROM  PD_DECRECIENTE_JUDICIAL_GESTION A
INNER JOIN #FondoFAE3 B
ON A.CONTRATO=B.CONTRATO

---------AÑADIDO 10/02/2022

If OBJECT_ID('tempdb..#Promotores') IS NOT NULL DROP TABLE #Promotores
select a.contrato,b.AMBITO_RCD
into #Promotores
from PD_DECRECIENTE_JUDICIAL_GESTION a
left join [XCOM_AMBITO_RCD_MES] b
ON A.CONTRATO=B.CONTRATO


delete from #Promotores where AMBITO_RCD not in ('PROMOTOR-BEC','PROMOTOR-MIN')

update #Promotores set AMBITO_RCD='SI'


UPDATE A
SET    A.Flag_Promotores=b.AMBITO_RCD
--select *
FROM  PD_DECRECIENTE_JUDICIAL_GESTION A
INNER JOIN #Promotores B
ON A.CONTRATO=B.CONTRATO

-----------------------------------------------------------------------

-------------CASOS PUNTUALES QUE OPPLUS ENVIÓ PARA LA ASIGNACION Y NO PASARON, SE ENVIO MAIL A PEVES POR ESTOS CASOS EL 23/02/2022- INCIDENCIA SAE
UPDATE A
SET A.[ESTUDIO ASIGNADO]=C.nomb_estu,
A.sigla=b.sigla,
A.FECHA_ASIGNACION=B.FECHA_ASIGNACION
--SELECT A.CONTRATO,A.[ESTUDIO ASIGNADO],A.sigla,A.FECHA_ASIGNACION,B.sigla,B.FECHA_ASIGNACION,C.nomb_estu
FROM PD_DECRECIENTE_JUDICIAL_GESTION AS A
INNER JOIN CQ_ASIGNACIONES_PENDIENTES_SAE AS B
ON A.CONTRATO=B.CONTRATO
INNER join pd_catalogo_estudios C
on B.sigla=C.sigla
WHERE A.[ESTUDIO ASIGNADO] IS NULL

-------------------------------------------------------

------------------------------------------------------------------------

DELETE FROM EX.COBRANZACM.DBO.PD_STOCK_JUDICIAL
WHERE FECHA=(SELECT MAX(FECHA) FROM PD_DECRECIENTE_JUDICIAL_GESTION) AND CLAVE='BC'

ALTER TABLE PD_DECRECIENTE_JUDICIAL_GESTION ALTER COLUMN Flag_Fondo_Reactiva varchar(12)
UPDATE A
SET A.Flag_Fondo_Reactiva = CASE WHEN b.Nuevo_Status_Envio = '3. Ex-Reactiva' THEN 'Ex-Reactiva'
WHEN b.Nuevo_Status_Envio in('0. Reprogramados','2. No Reprogramados') THEN 'Reactiva' ELSE ' ' END
FROM PD_DECRECIENTE_JUDICIAL_GESTION  A
inner join Bd_fondos b on a.contrato = b.contrato


INSERT INTO EX.COBRANZACM.DBO.PD_STOCK_JUDICIAL
select FECHA,CODCENTRAL,CONTRATO,sigla SIGLA_SAE,SUBPROD,LIMA_PROV PLAZA,
TIPO_CARTERA,CODOFIC,OFICINA,TERRITORIO,FECHA_ASIGNACION,[SEGMENTO DE NEGOCIO] SEGMENTO,Flag_Fondo_Reactiva FLAG_FONDO_REACTIVA,
Flag_Fondo_Crecer FLAG_FONDO_CRECER,Flag_FAE,Flag_Consumer FLAG_CONSUMER,Flag_Convenio FLAG_CONVENIO,'BC'
,VAL_REAL_HIPOTECA,VAL_REAL_PRENDA,FIADOR_CON_GARANTIA,CONVERT(DATE,GETDATE()),MIVIVIENDA
from PD_DECRECIENTE_JUDICIAL_GESTION

IF ((SELECT COUNT(*) FROM PD_FECHASCIERRE WHERE FECHACIERRE IN(SELECT MAX(FECHA) FROM PD_DECRECIENTE_JUDICIAL_GESTION))>0)
BEGIN
EXEC SP_PD_DISTRIBUCION_BC
END

EXEC PD_SEGUIMORA_IRBSA

EXEC SP_ELIMINA_TMP_SEGUIMORA

EXEC SP_ENVIO_SEGUIMORA

EXEC SP_AÑADIR_LEGAJOS_BEC

EXEC SP_ENVIO_STOCK_ESTUDIOS

EXEC EX.CobranzaCM.dbo.sp_baseprocesal

EXEC msdb.dbo.sp_start_job 'BaseProcesal'

EXEC PD_SEGUIMORA_KST

EXEC msdb.dbo.sp_start_job 'BaseCastigo'


-----------------------------------------Alerta por correo Electronico------------------------------------------
DECLARE @correo varchar(1000)
DECLARE @tabla varchar(8000)
DECLARE @profile as VARCHAR(1000),@asunto as VARCHAR(1000),@cuerpo as varchar(8000),@destinatarios as VARCHAR(1000),@copias as VARCHAR(1000),@copiasocultas as VARCHAR(1000),@adjuntos as VARCHAR(1000)
DECLARE @fecha as datetime

SET @asunto='Actualización del SOS'
SET @profile = 'Cobranzas Notificaciones'
SET @destinatarios=''
SET @copias =''
SET @copiasocultas='governancestrategies.group@bbva.com;'

SET @fecha=(select max(fecha) from pd_universo_diario)

SET @cuerpo=N'<html><body><font face=Arial size=2>Estimados, el SOS se encuentra actualizado al '+convert(varchar(10), @fecha, 103)+'.<BR>
<BR>Saludos,<BR><img src=https://extranetperu.grupobbva.pe/cobranzatm/Imagenes/LogoBBVA.png border=0><BR><BR><BR><b>Governance & Estrategies</b></font><BR><font size=2></font>
</body></html>'

--select @cuerpo
--select @asunto

--Insert Into ML.Cobranza.dbo.EnvioMailAutomatico
--select @profile as profile,@asunto as asunto,@cuerpo as cuerpo,@destinatarios as destinatarios, @copias as copias,@copiasocultas as copiasocultas,@adjuntos as adjuntoS
EXEC SP_ENVIARMAILHTML @profile,@asunto,@cuerpo,@destinatarios,@copias,@copiasocultas,@adjuntos


update JOB_Ejecucion
set tarea_en_ejecucion=null
,fecha_inicio_tarea=NULL
,estado=0
,ultimaejecucion=GETDATE()
where Descripcion='PROCESO_DIARIO'

END
  </body>
</html>
